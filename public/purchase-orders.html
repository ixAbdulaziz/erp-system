<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>إدارة أوامر الشراء</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700&display=swap');
    
    :root {
      --primary: linear-gradient(135deg, #475569 0%, #334155 100%);
      --accent: linear-gradient(135deg, #64748b 0%, #475569 100%);
      --success: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      --info: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      --warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      --edit: linear-gradient(135deg, #64748b 0%, #475569 100%);
      --glass: rgba(15, 23, 42, 0.8);
      --glass-light: rgba(30, 41, 59, 0.6);
      --border: rgba(148, 163, 184, 0.1);
      --border-light: rgba(148, 163, 184, 0.2);
      --text: #f8fafc;
      --text-secondary: #e2e8f0;
      --text-muted: #94a3b8;
      --shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
      --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    
    * { box-sizing: border-box; }
    
    body { 
      font-family: 'Tajawal', sans-serif; 
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 40%, #334155 100%);
      background-attachment: fixed;
      color: var(--text);
      overflow-x: hidden;
    }
    
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.3); border-radius: 10px; }
    ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%); }
    
    @keyframes fadeInUp { 0% { opacity: 0; transform: translateY(30px); } 100% { opacity: 1; transform: translateY(0); } }
    @keyframes slideInRight { 0% { opacity: 0; transform: translateX(30px); } 100% { opacity: 1; transform: translateX(0); } }
    @keyframes gentleShimmer { 0% { background-position: -200% center; } 100% { background-position: 200% center; } }
    @keyframes gentleFloat { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-8px); } }
    @keyframes gentlePulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
    @keyframes modalSlideIn { 0% { opacity: 0; transform: scale(0.9) translateY(-20px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
    @keyframes peacefulSuccess { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); } 70% { transform: scale(1.02); box-shadow: 0 0 0 15px rgba(34, 197, 94, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
    
    .fade-up { opacity: 0; transform: translateY(30px); animation: fadeInUp 0.8s ease forwards; }
    .slide-right { opacity: 0; transform: translateX(30px); animation: slideInRight 0.6s ease forwards; }
    
    /* Enhanced Sidebar */
    .sidebar {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%);
      backdrop-filter: blur(20px);
      border-left: 1px solid var(--border-light);
      box-shadow: var(--shadow);
    }
    
    .nav-link {
      transition: all 0.4s ease;
      position: relative;
      overflow: hidden;
      border-radius: 16px;
      margin: 4px 0;
      backdrop-filter: blur(10px);
    }
    
    .nav-link::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 0; height: 100%;
      background: var(--accent);
      transition: all 0.4s ease;
      z-index: -1;
      border-radius: 16px;
    }
    
    .nav-link:hover::before, .nav-link.active::before { width: 100%; }
    .nav-link:hover, .nav-link.active { 
      transform: translateX(-8px); 
      color: var(--text); 
      box-shadow: 0 8px 25px rgba(100, 116, 139, 0.3);
    }
    
    /* Enhanced Glass Cards */
    .glass-card, .modern-table-container, .page-header {
      background: var(--glass);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 32px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    
    .glass-card::before, .modern-table-container::before, .page-header::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: var(--accent);
      background-size: 200% 100%;
      animation: gentleShimmer 4s ease-in-out infinite;
    }
    
    /* Purchase Order Cards */
    .po-card {
      background: var(--glass);
      border-radius: 24px;
      padding: 32px;
      cursor: pointer;
      transition: all 0.5s ease;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(15px);
      margin-bottom: 24px;
    }
    
    .po-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: var(--info);
      transform: scaleX(0);
      transition: transform 0.4s ease;
    }
    
    .po-card:hover::before { transform: scaleX(1); }
    .po-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 50px rgba(14, 165, 233, 0.2);
      border-color: var(--border-light);
    }
    
    .po-card.expanded {
      background: rgba(30, 41, 59, 0.8);
      border-color: rgba(14, 165, 233, 0.3);
    }
    
    .po-card.expanded::before {
      background: var(--info);
      transform: scaleX(1);
    }
    
    .po-icon {
      background: var(--info);
      box-shadow: 0 8px 20px rgba(14, 165, 233, 0.3);
      animation: gentlePulse 4s ease-in-out infinite;
    }
    
    /* Invoice List within PO */
    .invoice-list {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }
    
    .invoice-item {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .invoice-item:hover {
      background: rgba(30, 41, 59, 0.7);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    
    .invoice-item:last-child {
      margin-bottom: 0;
    }
    
    .btn-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .modern-btn {
      background: var(--primary);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.4s ease;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }
    
    .modern-btn::before {
      content: '';
      position: absolute;
      top: 0; left: -100%;
      width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.6s ease;
    }
    
    .modern-btn:hover::before { left: 100%; }
    .modern-btn:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
      border-color: var(--border-light);
    }
    
    .modern-btn.success { background: var(--success); box-shadow: 0 8px 20px rgba(34, 197, 94, 0.3); }
    .modern-btn.warning { background: var(--warning); box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3); }
    .modern-btn.info { background: var(--info); box-shadow: 0 8px 20px rgba(14, 165, 233, 0.3); }
    .modern-btn.edit { background: linear-gradient(135deg, #64748b 0%, #475569 100%); box-shadow: 0 8px 20px rgba(100, 116, 139, 0.3); }
    
    .modern-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    /* Search Input Styling */
    .search-input {
      background: rgba(100, 116, 139, 0.15) !important;
      border: 2px solid rgba(100, 116, 139, 0.4) !important;
      border-radius: 12px;
      padding: 12px 16px;
      color: #e2e8f0 !important;
      font-size: 14px;
      font-weight: 500;
      backdrop-filter: blur(15px);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(100, 116, 139, 0.2) !important;
      text-align: right;
      direction: rtl;
      width: 100%;
    }
    
    .search-input:focus {
      outline: none !important;
      background: rgba(100, 116, 139, 0.2) !important;
      border-color: rgba(100, 116, 139, 0.6) !important;
      box-shadow: 0 0 20px rgba(100, 116, 139, 0.4) !important;
      transform: translateY(-1px);
      color: #f1f5f9 !important;
    }
    
    .search-input::placeholder {
      color: rgba(241, 245, 249, 0.7) !important;
      font-weight: 400;
      opacity: 0.9;
    }
    
    .search-input:hover {
      background: rgba(100, 116, 139, 0.18) !important;
      border-color: rgba(100, 116, 139, 0.5) !important;
      box-shadow: 0 6px 20px rgba(100, 116, 139, 0.25) !important;
    }
    
    /* Modal Styling */
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal.show { display: flex; }
    
    .modal-content {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%);
      border: 2px solid rgba(148, 163, 184, 0.2);
      border-radius: 24px;
      padding: 40px;
      max-width: 600px;
      width: 90%;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(25px);
      animation: modalSlideIn 0.3s ease forwards;
      position: relative;
    }
    
    .modal-content::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 4px;
      background: linear-gradient(90deg, #64748b 0%, #94a3b8 50%, #cbd5e1 100%);
      border-radius: 24px 24px 0 0;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #e2e8f0;
      margin-bottom: 8px;
      text-align: right;
      position: relative;
      transition: all 0.3s ease;
    }
    
    .form-label::after {
      content: '';
      position: absolute;
      bottom: -4px; right: 0;
      width: 0; height: 2px;
      background: var(--accent);
      transition: width 0.3s ease;
      border-radius: 2px;
    }
    
    .form-input, .form-textarea, .form-select {
      width: 100%;
      background: rgba(100, 116, 139, 0.15) !important;
      border: 2px solid rgba(100, 116, 139, 0.4) !important;
      border-radius: 10px;
      padding: 12px 16px;
      color: #f1f5f9 !important;
      font-size: 14px;
      font-weight: 500;
      backdrop-filter: blur(15px);
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(100, 116, 139, 0.2) !important;
      text-align: right;
      direction: rtl;
      outline: none;
      font-family: 'Tajawal', sans-serif;
    }
    
    .form-select {
      cursor: pointer;
    }
    
    .form-select option {
      background: #1e293b;
      color: #f1f5f9;
      padding: 10px;
      font-weight: 500;
    }
    
    .form-select option:hover {
      background: #334155;
    }
    
    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none !important;
      background: rgba(100, 116, 139, 0.2) !important;
      border-color: rgba(100, 116, 139, 0.6) !important;
      box-shadow: 0 0 15px rgba(100, 116, 139, 0.4) !important;
      color: #ffffff !important;
      transform: translateY(-1px);
    }
    
    .form-input:focus + .form-label::after { width: 100%; }
    
    .form-input::placeholder, .form-textarea::placeholder {
      color: rgba(241, 245, 249, 0.7) !important;
      font-weight: 400;
      opacity: 0.9;
    }
    
    .form-input:hover:not(:focus), .form-textarea:hover:not(:focus) {
      background: rgba(100, 116, 139, 0.18) !important;
      border-color: rgba(100, 116, 139, 0.5) !important;
      box-shadow: 0 6px 20px rgba(100, 116, 139, 0.25) !important;
    }
    
    .form-textarea {
      min-height: 100px;
      resize: vertical;
      line-height: 1.5;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    /* Enhanced Autocomplete System - exactly like add.html */
    .autocomplete-container {
      position: relative;
      width: 100%;
    }
    
    .autocomplete-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      margin-top: 4px;
    }
    
    .autocomplete-suggestions.show {
      display: block;
      animation: fadeInUp 0.3s ease forwards;
    }
    
    .autocomplete-item {
      padding: 12px 16px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 1px solid rgba(100, 116, 139, 0.1);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      position: relative;
      overflow: hidden;
    }
    
    .autocomplete-item:last-child {
      border-bottom: none;
    }
    
    .autocomplete-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 0;
      height: 100%;
      background: linear-gradient(90deg, rgba(100, 116, 139, 0.1), rgba(100, 116, 139, 0.2));
      transition: width 0.3s ease;
      z-index: -1;
    }
    
    .autocomplete-item:hover::before,
    .autocomplete-item.highlighted::before {
      width: 100%;
    }
    
    .autocomplete-item:hover,
    .autocomplete-item.highlighted {
      background: rgba(100, 116, 139, 0.15);
      color: var(--text);
      transform: translateX(-2px);
    }
    
    .autocomplete-item:first-child {
      border-radius: 12px 12px 0 0;
    }
    
    .autocomplete-item:last-child {
      border-radius: 0 0 12px 12px;
    }
    
    .autocomplete-item:only-child {
      border-radius: 12px;
    }
    
    .autocomplete-icon {
      width: 16px;
      height: 16px;
      color: var(--text-muted);
      flex-shrink: 0;
    }
    
    .autocomplete-item:hover .autocomplete-icon,
    .autocomplete-item.highlighted .autocomplete-icon {
      color: var(--text-secondary);
    }
    
    .autocomplete-match {
      font-weight: 600;
      color: var(--text);
      background: rgba(100, 116, 139, 0.2);
      padding: 1px 3px;
      border-radius: 3px;
    }
    
    .autocomplete-warning {
      margin-top: 6px;
      padding: 8px 12px;
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 8px;
      color: #fbbf24;
      font-size: 13px;
      font-weight: 500;
      display: none;
      align-items: center;
      gap: 6px;
      animation: fadeInUp 0.4s ease forwards;
    }
    
    .autocomplete-warning.show {
      display: flex;
    }
    
    .autocomplete-warning::before {
      content: '⚠️';
      font-size: 14px;
    }
    
    .autocomplete-no-results {
      padding: 12px 16px;
      color: var(--text-muted);
      text-align: center;
      font-size: 13px;
      font-style: italic;
    }
    
    /* Success state when supplier is selected */
    .autocomplete-container.selected .form-input {
      border-color: rgba(34, 197, 94, 0.6) !important;
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.3) !important;
    }
    
    .autocomplete-container.selected .form-label::after {
      background: var(--success);
      width: 100%;
    }
    
    /* Stats Styling */
    .stat-item {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 16px;
      padding: 16px;
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }
    
    .stat-item:hover {
      background: rgba(0, 0, 0, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }
    
    /* Toggle Button */
    .toggle-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .toggle-btn:hover {
      background: rgba(100, 116, 139, 0.2);
      color: var(--text);
    }
    
    .rotate-180 {
      transform: rotate(180deg);
    }
    
    /* Invoice Search Results */
    .invoice-search-result {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .invoice-search-result:hover {
      background: rgba(30, 41, 59, 0.9);
      border-color: var(--border-light);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    
    .invoice-search-result.selected {
      background: rgba(14, 165, 233, 0.2);
      border-color: rgba(14, 165, 233, 0.4);
      box-shadow: 0 0 20px rgba(14, 165, 233, 0.3);
    }
    
    .invoice-search-result .invoice-number {
      font-weight: bold;
      color: #60a5fa;
      font-size: 16px;
    }
    
    .invoice-search-result .invoice-supplier {
      color: #e2e8f0;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .invoice-search-result .invoice-amount {
      color: #22c55e;
      font-weight: bold;
      font-size: 14px;
    }
    
    .invoice-search-result .invoice-date {
      color: #94a3b8;
      font-size: 13px;
    }
    
    .no-results {
      text-align: center;
      padding: 20px;
      color: #94a3b8;
      font-style: italic;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .po-card { padding: 24px; }
      .page-header { margin-bottom: 24px; padding: 24px; }
      .btn-group { flex-direction: column; align-items: stretch; }
      .modern-btn { justify-content: center; }
      .form-row { grid-template-columns: 1fr; }
      
      .autocomplete-suggestions {
        max-height: 150px;
        font-size: 14px;
      }
      
      .autocomplete-item {
        padding: 10px 14px;
      }
      
      .autocomplete-warning {
        font-size: 12px;
        padding: 6px 10px;
      }
    }
    
    /* Success Message Animation */
    .success-message {
      animation: slideInFromRight 0.3s ease-out;
    }
    
    @keyframes slideInFromRight {
      0% { transform: translateX(100%); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }
  </style>
</head>
<body class="flex bg-gray-900 text-gray-100 min-h-screen">
  <!-- Sidebar -->
  <aside class="sidebar w-64 flex flex-col p-8 hidden md:block">
    <div class="text-center mb-12">
      <h1 class="text-3xl font-bold bg-gradient-to-r from-slate-400 via-slate-300 to-slate-500 bg-clip-text text-transparent">المشتريات</h1>
      <div class="w-20 h-1 bg-gradient-to-r from-slate-500 to-slate-400 mx-auto mt-3 rounded-full"></div>
    </div>
    <nav class="space-y-4 flex-1">
      <a href="home.html" class="nav-link block py-4 px-6">
        <span class="relative z-10 flex items-center gap-3">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
          </svg>
          لوحة المعلومات
        </span>
      </a>
      <a href="add.html" class="nav-link block py-4 px-6">
        <span class="relative z-10 flex items-center gap-3">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          إضافة فاتورة
        </span>
      </a>
      <a href="view.html" class="nav-link block py-4 px-6">
        <span class="relative z-10 flex items-center gap-3">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          عرض الفواتير
        </span>
      </a>
      <a href="purchase-orders.html" class="nav-link active block py-4 px-6">
        <span class="relative z-10 flex items-center gap-3">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
          </svg>
          أوامر الشراء
        </span>
      </a>
    </nav>
  </aside>
  
  <!-- Main Content -->
  <main class="flex-1 p-8 space-y-8">
    <!-- Purchase Orders List -->
    <section class="space-y-8 fade-up">
      <div class="page-header">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <div>
            <h2 class="text-3xl font-bold bg-gradient-to-r from-slate-300 via-slate-200 to-slate-400 bg-clip-text text-transparent mb-2">أوامر الشراء</h2>
            <p class="text-slate-400 text-base">إدارة أوامر الشراء والفواتير المرتبطة بها</p>
          </div>
          <div class="btn-group">
            <button id="add-po-btn" class="modern-btn success">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
              إضافة أمر شراء
            </button>
          </div>
          <div class="hidden md:block relative">
            <div class="w-16 h-16 po-icon rounded-2xl flex items-center justify-center">
              <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
              </svg>
            </div>
          </div>
        </div>
        
        <!-- Search -->
        <div class="mt-6">
          <div class="relative max-w-md">
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
              <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>
            <input type="text" id="po-search" class="search-input pr-10" placeholder="البحث في أوامر الشراء...">
          </div>
        </div>
      </div>
      
      <!-- Purchase Orders Container -->
      <div id="po-container" class="space-y-6"></div>
    </section>
  </main>
  
  <!-- Add/Edit Purchase Order Modal -->
  <div id="po-modal" class="modal">
    <div class="modal-content">
      <h3 id="modal-title" class="text-2xl font-bold mb-2">إضافة أمر شراء جديد</h3>
      <p class="mb-6 text-slate-400">أدخل بيانات أمر الشراء</p>
      
      <form id="po-form">
        <div class="form-row">
          <div class="form-group">
            <label for="po-supplier" class="form-label">اسم المورد</label>
            <div class="autocomplete-container">
              <input type="text" id="po-supplier" class="form-input" placeholder="أدخل اسم المورد" required autocomplete="off" />
              <div id="po-supplier-suggestions" class="autocomplete-suggestions"></div>
              <div id="po-supplier-warning" class="autocomplete-warning"></div>
            </div>
          </div>
          <div class="form-group">
            <label for="po-price" class="form-label">سعر أمر الشراء</label>
            <input type="number" id="po-price" class="form-input" placeholder="0.00" step="0.01" min="0" required>
          </div>
        </div>
        
        <div class="form-group">
          <label for="po-description" class="form-label">بيان أمر الشراء</label>
          <textarea id="po-description" class="form-textarea" placeholder="وصف تفصيلي لأمر الشراء..." required></textarea>
        </div>
        
        <div class="form-group">
          <label for="po-pdf" class="form-label">ملف PDF (اختياري)</label>
          <div class="relative">
            <input type="file" id="po-pdf" class="form-input" accept=".pdf" style="padding-top: 8px;">
            <div class="text-slate-500 text-sm mt-1 text-right">يمكنك رفع ملف PDF يحتوي على تفاصيل أمر الشراء</div>
          </div>
        </div>
      </form>
      
      <div class="btn-group mt-8">
        <button id="save-po-btn" class="modern-btn success">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          حفظ أمر الشراء
        </button>
        <button id="cancel-po-btn" class="modern-btn">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          إلغاء
        </button>
      </div>
    </div>
  </div>
  
  <!-- Link Invoice to PO Modal -->
  <div id="link-invoice-modal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="text-center mb-6">
        <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
          </svg>
        </div>
        <h3 class="text-2xl font-bold mb-2">ربط فاتورة بأمر الشراء</h3>
        <p class="text-slate-400">ابحث عن الفاتورة المراد ربطها بأمر الشراء الحالي</p>
      </div>
      
      <!-- Purchase Order Info -->
      <div class="bg-gradient-to-r from-slate-800 to-slate-700 rounded-2xl p-6 mb-6 border border-slate-600">
        <h4 class="text-lg font-bold text-slate-200 mb-3 flex items-center gap-2">
          <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
          أمر الشراء المحدد
        </h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="flex justify-start items-center text-right">
            <span class="text-slate-400 text-sm ml-2">رقم الأمر:</span>
            <span id="selected-po-id" class="font-bold text-blue-400"></span>
          </div>
          <div class="flex justify-start items-center text-right">
            <span class="text-slate-400 text-sm ml-2">المورد:</span>
            <span id="selected-po-supplier" class="font-semibold text-slate-200"></span>
          </div>
        </div>
      </div>
      
      <!-- Invoice Search -->
      <div class="form-group">
        <label class="form-label flex items-center gap-2 mb-4">
          <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          ابحث عن الفاتورة المراد ربطها
        </label>
        <div class="relative">
          <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
            <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
          <input type="text" id="invoice-search" class="form-input pr-10" placeholder="ابحث برقم الفاتورة أو اسم المورد..." autocomplete="off">
        </div>
        
        <!-- Search Results -->
        <div id="invoice-search-results" class="mt-3 max-h-64 overflow-y-auto space-y-2 hidden">
          <!-- Results will be populated here -->
        </div>
        
        <p class="text-slate-500 text-sm mt-2 text-right">ملاحظة: ستظهر هنا الفواتير غير المربوطة بأوامر شراء أخرى فقط</p>
      </div>
      
      <!-- Selected Invoice Details -->
      <div id="selected-invoice-details" class="bg-gradient-to-r from-green-900/30 to-green-800/30 rounded-2xl p-6 mb-6 border border-green-600/30 hidden">
        <h4 class="text-lg font-bold text-green-300 mb-3 flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          تفاصيل الفاتورة المحددة
        </h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="flex justify-start items-center text-right">
            <span class="text-green-200 text-sm ml-2">رقم الفاتورة:</span>
            <span id="selected-invoice-number" class="font-bold text-green-300"></span>
          </div>
          <div class="flex justify-start items-center text-right">
            <span class="text-green-200 text-sm ml-2">التاريخ:</span>
            <span id="selected-invoice-date" class="font-semibold text-green-200"></span>
          </div>
          <div class="flex justify-start items-center text-right">
            <span class="text-green-200 text-sm ml-2">المورد:</span>
            <span id="selected-invoice-supplier" class="font-semibold text-green-200"></span>
          </div>
          <div class="flex justify-start items-center text-right">
            <span class="text-green-200 text-sm ml-2">المبلغ الإجمالي:</span>
            <span id="selected-invoice-amount" class="font-bold text-green-300"></span>
          </div>
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="btn-group mt-8 justify-center">
        <button id="link-invoice-btn" class="modern-btn info" disabled>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
          </svg>
          ربط الفاتورة بأمر الشراء
        </button>
        <button id="cancel-link-btn" class="modern-btn">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          إلغاء العملية
        </button>
      </div>
    </div>
  </div>
  
  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="modal">
    <div class="modal-content">
      <div class="text-center">
        <div class="w-20 h-20 bg-red-500 rounded-full flex items-center justify-center mx-auto mb-6">
          <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
        </div>
        <h3 class="text-2xl font-bold mb-4">حذف أمر الشراء</h3>
        <p class="text-slate-400 mb-6">هل أنت متأكد من حذف أمر الشراء؟ سيتم إلغاء ربط جميع الفواتير المرتبطة به.</p>
      </div>
      
      <div class="btn-group justify-center">
        <button id="confirm-delete-btn" class="modern-btn" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
          حذف أمر الشراء
        </button>
        <button id="cancel-delete-btn" class="modern-btn">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          إلغاء
        </button>
      </div>
    </div>
  </div>
  
  <!-- PDF Viewer Modal -->
  <div id="pdf-modal" class="modal">
    <div class="modal-content" style="max-width: 90vw; max-height: 90vh; width: 800px; height: 600px; padding: 20px;">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">عرض ملف PDF</h3>
        <button id="close-pdf-btn" class="modern-btn">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          إغلاق
        </button>
      </div>
      <div class="w-full h-full bg-slate-800 rounded-lg overflow-hidden">
        <iframe id="pdf-viewer" class="w-full h-full border-0" style="min-height: 500px;"></iframe>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Sample data - في الواقع، هذه البيانات ستأتي من localStorage أو API
      let purchaseOrders = JSON.parse(localStorage.getItem('purchaseOrders') || '[]');
      let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
      let filteredPOs = [];
      let currentEditingPO = null;
      let currentLinkingPO = null;
      let currentDeletingPO = null;
      let searchResults = [];
      let selectedInvoice = null;
      
      // Supplier autocomplete variables
      let suppliers = [];
      let selectedSupplier = null;
      let highlightedIndex = -1;
      let searchTimeout;
      
      // إضافة بيانات تجريبية إذا لم توجد أوامر شراء
      if (purchaseOrders.length === 0) {
        purchaseOrders = [
          {
            id: 'PO-001',
            supplier: 'شركة الخليج للتجارة',
            description: 'أجهزة كمبيوتر ومعدات مكتبية للفرع الجديد',
            price: 45000,
            createdDate: '2025-01-15',
            status: 'active',
            pdfFile: null
          },
          {
            id: 'PO-002',
            supplier: 'مؤسسة التقنية المتقدمة',
            description: 'خدمات صيانة وتطوير البرمجيات',
            price: 22000,
            createdDate: '2025-01-20',
            status: 'active',
            pdfFile: null
          }
        ];
        localStorage.setItem('purchaseOrders', JSON.stringify(purchaseOrders));
      }
      
      // إضافة بيانات فواتير تجريبية إذا لم توجد فواتير
      if (invoices.length === 0) {
        invoices = [
          {
            invoiceNumber: 'INV-001',
            supplier: 'شركة الخليج للتجارة',
            date: '2025-01-16',
            totalAmount: 15000
          },
          {
            invoiceNumber: 'INV-002',
            supplier: 'مؤسسة التقنية المتقدمة',
            date: '2025-01-22',
            totalAmount: 8500
          },
          {
            invoiceNumber: 'INV-003',
            supplier: 'شركة النجوم للخدمات',
            date: '2025-01-25',
            totalAmount: 12300
          }
        ];
        localStorage.setItem('invoices', JSON.stringify(invoices));
      }
      
      // DOM Elements
      const elements = {
        poContainer: document.getElementById('po-container'),
        poSearch: document.getElementById('po-search'),
        addPOBtn: document.getElementById('add-po-btn'),
        poModal: document.getElementById('po-modal'),
        modalTitle: document.getElementById('modal-title'),
        poSupplier: document.getElementById('po-supplier'),
        poSupplierSuggestions: document.getElementById('po-supplier-suggestions'),
        poSupplierWarning: document.getElementById('po-supplier-warning'),
        poSupplierContainer: document.querySelector('.autocomplete-container'),
        poDescription: document.getElementById('po-description'),
        poPrice: document.getElementById('po-price'),
        poPDF: document.getElementById('po-pdf'),
        savePOBtn: document.getElementById('save-po-btn'),
        cancelPOBtn: document.getElementById('cancel-po-btn'),
        linkInvoiceModal: document.getElementById('link-invoice-modal'),
        invoiceSearch: document.getElementById('invoice-search'),
        invoiceSearchResults: document.getElementById('invoice-search-results'),
        linkInvoiceBtn: document.getElementById('link-invoice-btn'),
        cancelLinkBtn: document.getElementById('cancel-link-btn'),
        deleteModal: document.getElementById('delete-modal'),
        confirmDeleteBtn: document.getElementById('confirm-delete-btn'),
        cancelDeleteBtn: document.getElementById('cancel-delete-btn'),
        pdfModal: document.getElementById('pdf-modal'),
        pdfViewer: document.getElementById('pdf-viewer'),
        closePdfBtn: document.getElementById('close-pdf-btn')
      };
      
      // Load suppliers from localStorage (same as add.html)
      function loadSuppliers() {
        const savedInvoices = JSON.parse(localStorage.getItem('invoices') || '[]');
        const savedPOs = JSON.parse(localStorage.getItem('purchaseOrders') || '[]');
        
        // Get unique suppliers from both invoices and purchase orders
        const invoiceSuppliers = savedInvoices.map(inv => inv.supplier?.trim()).filter(Boolean);
        const poSuppliers = savedPOs.map(po => po.supplier?.trim()).filter(Boolean);
        
        const uniqueSuppliers = [...new Set([...invoiceSuppliers, ...poSuppliers])];
        
        // Add some sample suppliers for demonstration
        const sampleSuppliers = [
          'شركة الأتقان للسفر والسياحة',
          'مؤسسة البناء الحديث',
          'شركة التقنيات المتقدمة',
          'مكتب الاستشارات الهندسية',
          'شركة النقل السريع',
          'مؤسسة الخدمات الطبية',
          'شركة الإعلانات الرقمية',
          'مكتب المحاماة والاستشارات القانونية',
          'شركة الصيانة الشاملة',
          'مؤسسة التعليم والتدريب',
          'شركة الخليج للتجارة',
          'مؤسسة التقنية المتقدمة'
        ];
        
        suppliers = [...new Set([...uniqueSuppliers, ...sampleSuppliers])].sort();
      }
      
      // Fuzzy search function (same as add.html)
      function fuzzySearch(query, text) {
        const queryLower = query.toLowerCase();
        const textLower = text.toLowerCase();
        
        // Direct match
        if (textLower.includes(queryLower)) {
          return { score: 100, match: true };
        }
        
        // Character-by-character matching
        let score = 0;
        let queryIndex = 0;
        
        for (let i = 0; i < textLower.length && queryIndex < queryLower.length; i++) {
          if (textLower[i] === queryLower[queryIndex]) {
            score += 2;
            queryIndex++;
          }
        }
        
        // Bonus for matching at word boundaries
        const words = textLower.split(/\s+/);
        for (const word of words) {
          if (word.startsWith(queryLower)) {
            score += 10;
            break;
          }
        }
        
        return { 
          score: score, 
          match: queryIndex === queryLower.length && score > queryLower.length 
        };
      }
      
      // Search suppliers (same as add.html)
      function searchSuppliers(query) {
        if (query.length < 2) return [];
        
        const results = suppliers
          .map(supplier => {
            const searchResult = fuzzySearch(query, supplier);
            return {
              name: supplier,
              score: searchResult.score,
              match: searchResult.match
            };
          })
          .filter(item => item.match)
          .sort((a, b) => b.score - a.score)
          .slice(0, 8);
        
        return results;
      }
      
      // Highlight matching text (same as add.html)
      function highlightMatch(text, query) {
        if (!query) return text;
        
        const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        return text.replace(regex, '<span class="autocomplete-match">$1</span>');
      }
      
      // Show suggestions (same as add.html)
      function showSuggestions(suggestions) {
        const container = elements.poSupplierSuggestions;
        
        if (suggestions.length === 0) {
          container.innerHTML = '<div class="autocomplete-no-results">لا توجد نتائج مطابقة</div>';
          container.classList.add('show');
          return;
        }
        
        const suggestionHTML = suggestions.map((item, index) => {
          const highlightedName = highlightMatch(item.name, elements.poSupplier.value);
          return `
            <div class="autocomplete-item" data-index="${index}" data-supplier="${item.name}">
              <svg class="autocomplete-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H3m2 0h4M9 7h6m-6 4h6m-6 4h6m-6 4h6"></path>
              </svg>
              <span>${highlightedName}</span>
            </div>
          `;
        }).join('');
        
        container.innerHTML = suggestionHTML;
        container.classList.add('show');
        highlightedIndex = -1;
      }
      
      // Hide suggestions (same as add.html)
      function hideSuggestions() {
        elements.poSupplierSuggestions.classList.remove('show');
        highlightedIndex = -1;
      }
      
      // Show warning (same as add.html)
      function showWarning(message) {
        elements.poSupplierWarning.textContent = message;
        elements.poSupplierWarning.classList.add('show');
        
        setTimeout(() => {
          elements.poSupplierWarning.classList.remove('show');
        }, 5000);
      }
      
      // Hide warning (same as add.html)
      function hideWarning() {
        elements.poSupplierWarning.classList.remove('show');
      }
      
      // Select supplier (same as add.html)
      function selectSupplier(supplierName) {
        elements.poSupplier.value = supplierName;
        selectedSupplier = supplierName;
        elements.poSupplierContainer.classList.add('selected');
        hideSuggestions();
        hideWarning();
        
        // Add success animation
        elements.poSupplier.style.animation = 'peacefulSuccess 0.6s ease-out';
        setTimeout(() => {
          elements.poSupplier.style.animation = '';
        }, 600);
      }
      
      // Handle keyboard navigation (same as add.html)
      function handleKeyboardNavigation(e) {
        const items = elements.poSupplierSuggestions.querySelectorAll('.autocomplete-item');
        
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
          updateHighlight(items);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          highlightedIndex = Math.max(highlightedIndex - 1, -1);
          updateHighlight(items);
        } else if (e.key === 'Enter' && highlightedIndex >= 0) {
          e.preventDefault();
          const selectedItem = items[highlightedIndex];
          if (selectedItem) {
            selectSupplier(selectedItem.dataset.supplier);
          }
        } else if (e.key === 'Escape') {
          hideSuggestions();
        }
      }
      
      // Update highlight (same as add.html)
      function updateHighlight(items) {
        items.forEach((item, index) => {
          if (index === highlightedIndex) {
            item.classList.add('highlighted');
            item.scrollIntoView({ block: 'nearest' });
          } else {
            item.classList.remove('highlighted');
          }
        });
      }
      
      // Initialize autocomplete (same as add.html)
      function initAutocomplete() {
        loadSuppliers();
        
        // Input event handler
        elements.poSupplier.addEventListener('input', (e) => {
          const query = e.target.value.trim();
          selectedSupplier = null;
          elements.poSupplierContainer.classList.remove('selected');
          
          if (searchTimeout) {
            clearTimeout(searchTimeout);
          }
          
          if (query.length < 2) {
            hideSuggestions();
            hideWarning();
            return;
          }
          
          // Show loading state
          elements.poSupplierSuggestions.innerHTML = '<div class="autocomplete-loading">جاري البحث...</div>';
          elements.poSupplierSuggestions.classList.add('show');
          
          // Debounce search
          searchTimeout = setTimeout(() => {
            const suggestions = searchSuppliers(query);
            showSuggestions(suggestions);
            
            if (query.length > 3 && suggestions.length === 0) {
              showWarning('لم يتم العثور على موردين مطابقين. تحقق من الاسم لتفادي التكرار.');
            } else if (query.length > 3 && !suggestions.some(s => s.name.toLowerCase() === query.toLowerCase())) {
              showWarning('تحقق من الأسماء المقترحة لتفادي تكرار الموردين.');
            } else {
              hideWarning();
            }
          }, 300);
        });
        
        // Keyboard navigation
        elements.poSupplier.addEventListener('keydown', handleKeyboardNavigation);
        
        // Click handler for suggestions
        elements.poSupplierSuggestions.addEventListener('click', (e) => {
          const item = e.target.closest('.autocomplete-item');
          if (item) {
            selectSupplier(item.dataset.supplier);
          }
        });
        
        // Focus handler
        elements.poSupplier.addEventListener('focus', () => {
          if (elements.poSupplier.value.length >= 2) {
            const suggestions = searchSuppliers(elements.poSupplier.value);
            showSuggestions(suggestions);
          }
        });
        
        // Blur handler
        elements.poSupplier.addEventListener('blur', () => {
          setTimeout(() => {
            hideSuggestions();
          }, 200);
        });
        
        // Prevent form submission when selecting from autocomplete
        elements.poSupplierSuggestions.addEventListener('mousedown', (e) => {
          e.preventDefault();
        });
      }
      
      // Generate unique ID for purchase orders
      function generatePOId() {
        const lastPO = purchaseOrders.reduce((max, po) => {
          const num = parseInt(po.id.split('-')[1]);
          return num > max ? num : max;
        }, 0);
        return `PO-${String(lastPO + 1).padStart(3, '0')}`;
      }
      
      // Get invoices linked to PO
      function getLinkedInvoices(poId) {
        return invoices.filter(invoice => invoice.purchaseOrderId === poId);
      }
      
      // Get unlinked invoices
      function getUnlinkedInvoices() {
        return invoices.filter(invoice => !invoice.purchaseOrderId);
      }
      
      // Search invoices
      function searchInvoices(searchTerm) {
        const unlinkedInvoices = getUnlinkedInvoices();
        
        if (!searchTerm.trim()) {
          searchResults = [];
          renderSearchResults();
          return;
        }
        
        searchResults = unlinkedInvoices.filter(invoice => 
          invoice.invoiceNumber.toLowerCase().includes(searchTerm.toLowerCase()) ||
          invoice.supplier.toLowerCase().includes(searchTerm.toLowerCase())
        );
        
        renderSearchResults();
      }
      
      // Render search results
      function renderSearchResults() {
        const container = elements.invoiceSearchResults;
        
        if (searchResults.length === 0) {
          if (elements.invoiceSearch.value.trim()) {
            container.innerHTML = '<div class="no-results">لا توجد فواتير تطابق البحث</div>';
            container.classList.remove('hidden');
          } else {
            container.classList.add('hidden');
          }
          return;
        }
        
        container.innerHTML = searchResults.map(invoice => `
          <div class="invoice-search-result" data-invoice="${invoice.invoiceNumber}" onclick="selectInvoice('${invoice.invoiceNumber}')">
            <div class="flex justify-between items-start mb-2">
              <div class="text-right">
                <div class="invoice-number">${invoice.invoiceNumber}</div>
                <div class="invoice-supplier">${invoice.supplier}</div>
              </div>
              <div class="text-left">
                <div class="invoice-amount">${invoice.totalAmount.toLocaleString()} ر.س</div>
                <div class="invoice-date">${invoice.date}</div>
              </div>
            </div>
          </div>
        `).join('');
        
        container.classList.remove('hidden');
      }
      
      // Select invoice from search results
      function selectInvoice(invoiceNumber) {
        selectedInvoice = invoiceNumber;
        const invoice = invoices.find(inv => inv.invoiceNumber === invoiceNumber);
        
        // Clear search and hide results
        elements.invoiceSearch.value = `${invoice.invoiceNumber} - ${invoice.supplier}`;
        elements.invoiceSearchResults.classList.add('hidden');
        
        // Show invoice details
        showInvoiceDetails(invoiceNumber);
        
        // Enable link button
        elements.linkInvoiceBtn.disabled = false;
        elements.linkInvoiceBtn.style.opacity = '1';
      }
      
      // Clear search
      function clearSearch() {
        elements.invoiceSearch.value = '';
        elements.invoiceSearchResults.classList.add('hidden');
        searchResults = [];
        selectedInvoice = null;
        hideInvoiceDetails();
      }
      
      // Sort purchase orders by ID (newest first)
      function sortPurchaseOrdersById(pos) {
        return pos.sort((a, b) => {
          // استخراج الرقم التسلسلي من ID (مثل PO-001 -> 1)
          const idA = parseInt(a.id.split('-')[1]);
          const idB = parseInt(b.id.split('-')[1]);
          return idB - idA; // الأحدث أولاً (رقم أكبر = أحدث)
        });
      }

      
      // Render purchase orders
      function renderPurchaseOrders() {
        elements.poContainer.innerHTML = '';
        
        // ترتيب أوامر الشراء بحسب الـ ID من الأحدث إلى الأقدم
        const sortedPOs = sortPurchaseOrdersById([...filteredPOs]);
        
        sortedPOs.forEach((po, index) => {
          const linkedInvoices = getLinkedInvoices(po.id);
          const totalInvoiceAmount = linkedInvoices.reduce((sum, inv) => sum + (inv.totalAmount || 0), 0);
          
          const poCard = document.createElement('div');
          poCard.className = 'po-card slide-right';
          poCard.style.animationDelay = `${index * 0.1}s`;
          poCard.dataset.poId = po.id;
          
          poCard.innerHTML = `
            <div class="flex items-start justify-between mb-6">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 po-icon rounded-2xl flex items-center justify-center">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                  </svg>
                </div>
                <div>
                  <h3 class="text-xl font-bold text-slate-100">${po.id}</h3>
                  <p class="text-slate-400 text-sm">${po.createdDate}</p>
                </div>
              </div>
              
              <div class="btn-group">
                <button class="modern-btn edit" onclick="editPO('${po.id}')" title="تعديل">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                </button>
                <button class="modern-btn info" onclick="linkInvoice('${po.id}')" title="ربط فاتورة">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                  </svg>
                </button>
                <button class="modern-btn" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);" onclick="deletePO('${po.id}')" title="حذف">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </button>
              </div>
            </div>
            
            <!-- PO Details -->
            <div class="space-y-4 mb-6">
              <div class="stat-item">
                <div class="flex justify-start items-start text-right">
                  <span class="text-sm text-slate-400 ml-2">المورد:</span>
                  <span class="font-bold text-slate-200 flex-1">${po.supplier}</span>
                </div>
              </div>
              
              <div class="stat-item">
                <div class="flex justify-start items-start text-right">
                  <span class="text-sm text-slate-400 ml-2">البيان:</span>
                  <span class="text-slate-200 flex-1">${po.description}</span>
                </div>
              </div>
              
              ${po.pdfFile ? `
              <div class="stat-item">
                <div class="flex justify-between items-center text-right">
                  <div class="flex justify-start items-center">
                    <span class="text-sm text-slate-400 ml-2">ملف PDF:</span>
                    <span class="text-slate-200">${po.pdfFile.name}</span>
                  </div>
                  <div class="flex gap-2">
                    <button class="modern-btn info" onclick="viewPDF('${po.id}')" title="عرض الملف">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                      </svg>
                    </button>
                    <button class="modern-btn warning" onclick="downloadPDF('${po.id}')" title="تحميل الملف">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
              ` : ''}
              
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="stat-item">
                  <div class="text-center">
                    <p class="text-sm text-slate-400">سعر الأمر</p>
                    <p class="font-bold text-blue-400 text-lg">${po.price.toLocaleString()} ر.س</p>
                  </div>
                </div>
                <div class="stat-item">
                  <div class="text-center">
                    <p class="text-sm text-slate-400">الفواتير المربوطة</p>
                    <p class="font-bold text-green-400 text-lg">${linkedInvoices.length}</p>
                  </div>
                </div>
                <div class="stat-item">
                  <div class="text-center">
                    <p class="text-sm text-slate-400">إجمالي الفواتير</p>
                    <p class="font-bold text-yellow-400 text-lg">${totalInvoiceAmount.toLocaleString()} ر.س</p>
                  </div>
                </div>
                <div class="stat-item">
                  <div class="text-center">
                    <p class="text-sm text-slate-400">ملف PDF</p>
                    <p class="font-bold ${po.pdfFile ? 'text-green-400' : 'text-red-400'} text-lg">
                      ${po.pdfFile ? 'متوفر' : 'غير متوفر'}
                    </p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Toggle Button -->
            <div class="border-t border-slate-600/30 pt-4">
              <button class="toggle-btn w-full" onclick="toggleInvoices('${po.id}')">
                <span>عرض الفواتير المربوطة (${linkedInvoices.length})</span>
                <svg class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
            </div>
            
            <!-- Linked Invoices (Hidden by default) -->
            <div class="invoice-list hidden" id="invoices-${po.id}">
              ${linkedInvoices.length > 0 ? linkedInvoices.map(invoice => `
                <div class="invoice-item">
                  <div class="flex justify-between items-center">
                    <div class="flex-1 text-right">
                      <div class="flex justify-start items-start mb-2">
                        <span class="text-sm text-slate-400 ml-2">رقم الفاتورة:</span>
                        <span class="font-semibold text-slate-200">${invoice.invoiceNumber}</span>
                        <span class="text-slate-400 text-sm mr-4">${invoice.date}</span>
                      </div>
                      <div class="flex justify-start items-center">
                        <span class="text-sm text-slate-400 ml-2">المورد:</span>
                        <span class="text-slate-300 text-sm font-medium">${invoice.supplier}</span>
                        <span class="font-bold text-green-400 mr-4">${invoice.totalAmount.toLocaleString()} ر.س</span>
                      </div>
                    </div>
                    <button class="modern-btn edit mr-4" onclick="unlinkInvoice('${invoice.invoiceNumber}')" title="إلغاء الربط">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                      </svg>
                    </button>
                  </div>
                </div>
              `).join('') : '<p class="text-slate-400 text-center py-4">لا توجد فواتير مربوطة بهذا الأمر</p>'}
            </div>
          `;
          
          elements.poContainer.appendChild(poCard);
        });
      }
      
      // Filter purchase orders
      function filterPurchaseOrders(searchTerm) {
        if (!searchTerm.trim()) {
          filteredPOs = [...purchaseOrders];
        } else {
          filteredPOs = purchaseOrders.filter(po => 
            po.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
            po.supplier.toLowerCase().includes(searchTerm.toLowerCase()) ||
            po.description.toLowerCase().includes(searchTerm.toLowerCase())
          );
        }
        renderPurchaseOrders();
      }
      
      // Show invoice details
      function showInvoiceDetails(invoiceNumber) {
        const invoice = invoices.find(inv => inv.invoiceNumber === invoiceNumber);
        if (!invoice) return;
        
        document.getElementById('selected-invoice-number').textContent = invoice.invoiceNumber;
        document.getElementById('selected-invoice-date').textContent = invoice.date;
        document.getElementById('selected-invoice-supplier').textContent = invoice.supplier;
        document.getElementById('selected-invoice-amount').textContent = `${invoice.totalAmount.toLocaleString()} ر.س`;
        
        document.getElementById('selected-invoice-details').classList.remove('hidden');
      }
      
      // Hide invoice details
      function hideInvoiceDetails() {
        document.getElementById('selected-invoice-details').classList.add('hidden');
        selectedInvoice = null;
        elements.linkInvoiceBtn.disabled = true;
        elements.linkInvoiceBtn.style.opacity = '0.5';
      }
      
      // Make selectInvoice globally available
      window.selectInvoice = selectInvoice;
      
      // PDF Functions
      window.viewPDF = function(poId) {
        const po = purchaseOrders.find(p => p.id === poId);
        if (!po || !po.pdfFile) return;
        
        elements.pdfViewer.src = po.pdfFile.dataUrl;
        elements.pdfModal.classList.add('show');
      };
      
      window.downloadPDF = function(poId) {
        const po = purchaseOrders.find(p => p.id === poId);
        if (!po || !po.pdfFile) return;
        
        const link = document.createElement('a');
        link.href = po.pdfFile.dataUrl;
        link.download = po.pdfFile.name;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };
      
      // Global functions
      window.editPO = function(poId) {
        const po = purchaseOrders.find(p => p.id === poId);
        if (!po) return;
        
        currentEditingPO = po;
        elements.modalTitle.textContent = 'تعديل أمر الشراء';
        elements.poSupplier.value = po.supplier;
        elements.poDescription.value = po.description;
        elements.poPrice.value = po.price;
        elements.poPDF.value = ''; // Can't set file input value
        
        // Reset autocomplete state
        selectedSupplier = po.supplier;
        elements.poSupplierContainer.classList.add('selected');
        hideSuggestions();
        hideWarning();
        
        elements.poModal.classList.add('show');
      };
      
      window.linkInvoice = function(poId) {
        const po = purchaseOrders.find(p => p.id === poId);
        if (!po) return;
        
        currentLinkingPO = poId;
        
        // Update PO details in modal
        document.getElementById('selected-po-id').textContent = po.id;
        document.getElementById('selected-po-supplier').textContent = po.supplier;
        
        // Clear previous search
        clearSearch();
        
        elements.linkInvoiceModal.classList.add('show');
      };
      
      window.deletePO = function(poId) {
        currentDeletingPO = poId;
        elements.deleteModal.classList.add('show');
      };
      
      window.toggleInvoices = function(poId) {
        const invoicesList = document.getElementById(`invoices-${poId}`);
        const poCard = document.querySelector(`[data-po-id="${poId}"]`);
        const arrow = poCard.querySelector('.toggle-btn svg');
        
        if (invoicesList.classList.contains('hidden')) {
          invoicesList.classList.remove('hidden');
          arrow.classList.add('rotate-180');
          poCard.classList.add('expanded');
        } else {
          invoicesList.classList.add('hidden');
          arrow.classList.remove('rotate-180');
          poCard.classList.remove('expanded');
        }
      };
      
      window.unlinkInvoice = function(invoiceNumber) {
        const invoice = invoices.find(inv => inv.invoiceNumber === invoiceNumber);
        if (invoice) {
          delete invoice.purchaseOrderId;
          localStorage.setItem('invoices', JSON.stringify(invoices));
          renderPurchaseOrders();
        }
      };
      
      // Add new purchase order
      function addPurchaseOrder() {
        currentEditingPO = null;
        elements.modalTitle.textContent = 'إضافة أمر شراء جديد';
        elements.poSupplier.value = '';
        elements.poDescription.value = '';
        elements.poPrice.value = '';
        elements.poPDF.value = '';
        
        // Reset autocomplete state
        selectedSupplier = null;
        elements.poSupplierContainer.classList.remove('selected');
        hideSuggestions();
        hideWarning();
        
        elements.poModal.classList.add('show');
      }
      
      // Save purchase order
      function savePurchaseOrder() {
        const supplier = elements.poSupplier.value.trim();
        const description = elements.poDescription.value.trim();
        const price = parseFloat(elements.poPrice.value);
        const pdfFile = elements.poPDF.files[0];
        
        if (!supplier || !description || !price) {
          alert('يرجى ملء جميع الحقول المطلوبة');
          return;
        }
        
        function savePO(pdfData = null) {
          if (currentEditingPO) {
            // Edit existing PO
            const index = purchaseOrders.findIndex(po => po.id === currentEditingPO.id);
            if (index !== -1) {
              purchaseOrders[index] = {
                ...currentEditingPO,
                supplier,
                description,
                price,
                pdfFile: pdfData || currentEditingPO.pdfFile
              };
            }
          } else {
            // Add new PO
            const newPO = {
              id: generatePOId(),
              supplier,
              description,
              price,
              createdDate: new Date().toISOString().split('T')[0],
              status: 'active',
              pdfFile: pdfData
            };
            purchaseOrders.push(newPO);
          }
          
          localStorage.setItem('purchaseOrders', JSON.stringify(purchaseOrders));
          
          // Update suppliers list for autocomplete
          if (supplier && !suppliers.includes(supplier)) {
            suppliers.push(supplier);
            suppliers.sort();
          }
          
          filteredPOs = [...purchaseOrders];
          renderPurchaseOrders();
          elements.poModal.classList.remove('show');
        }
        
        // Handle PDF file if uploaded
        if (pdfFile) {
          if (pdfFile.type !== 'application/pdf') {
            alert('يرجى اختيار ملف PDF صالح');
            return;
          }
          
          if (pdfFile.size > 10 * 1024 * 1024) { // 10MB limit
            alert('حجم الملف كبير جداً. يرجى اختيار ملف أصغر من 10 ميجابايت');
            return;
          }
          
          const reader = new FileReader();
          reader.onload = function(e) {
            const pdfData = {
              name: pdfFile.name,
              size: pdfFile.size,
              dataUrl: e.target.result
            };
            savePO(pdfData);
          };
          reader.readAsDataURL(pdfFile);
        } else {
          savePO();
        }
      }
      
      // Link invoice to PO
      function linkInvoiceToPO() {
        if (!selectedInvoice || !currentLinkingPO) return;
        
        const invoice = invoices.find(inv => inv.invoiceNumber === selectedInvoice);
        if (invoice) {
          invoice.purchaseOrderId = currentLinkingPO;
          localStorage.setItem('invoices', JSON.stringify(invoices));
          renderPurchaseOrders();
          elements.linkInvoiceModal.classList.remove('show');
          clearSearch();
          
          // Show success message
          const successMessage = document.createElement('div');
          successMessage.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 success-message';
          successMessage.textContent = `تم ربط الفاتورة ${selectedInvoice} بنجاح!`;
          document.body.appendChild(successMessage);
          
          setTimeout(() => {
            successMessage.remove();
          }, 3000);
        }
      }
      
      // Delete purchase order
      function deletePurchaseOrder() {
        if (!currentDeletingPO) return;
        
        // Unlink all invoices from this PO
        invoices.forEach(invoice => {
          if (invoice.purchaseOrderId === currentDeletingPO) {
            delete invoice.purchaseOrderId;
          }
        });
        
        // Remove PO
        purchaseOrders = purchaseOrders.filter(po => po.id !== currentDeletingPO);
        
        localStorage.setItem('purchaseOrders', JSON.stringify(purchaseOrders));
        localStorage.setItem('invoices', JSON.stringify(invoices));
        
        filteredPOs = [...purchaseOrders];
        renderPurchaseOrders();
        elements.deleteModal.classList.remove('show');
      }
      
      // Event listeners
      elements.addPOBtn.addEventListener('click', addPurchaseOrder);
      elements.savePOBtn.addEventListener('click', savePurchaseOrder);
      elements.cancelPOBtn.addEventListener('click', () => {
        elements.poModal.classList.remove('show');
        hideSuggestions();
        hideWarning();
      });
      elements.linkInvoiceBtn.addEventListener('click', linkInvoiceToPO);
      elements.cancelLinkBtn.addEventListener('click', () => {
        elements.linkInvoiceModal.classList.remove('show');
        clearSearch();
      });
      elements.confirmDeleteBtn.addEventListener('click', deletePurchaseOrder);
      elements.cancelDeleteBtn.addEventListener('click', () => elements.deleteModal.classList.remove('show'));
      elements.closePdfBtn.addEventListener('click', () => elements.pdfModal.classList.remove('show'));
      
      elements.poSearch.addEventListener('input', (e) => {
        filterPurchaseOrders(e.target.value);
      });
      
      // Invoice search functionality
      elements.invoiceSearch.addEventListener('input', (e) => {
        searchInvoices(e.target.value);
      });
      
      // Hide search results when clicking outside
      document.addEventListener('click', (e) => {
        if (!elements.invoiceSearch.contains(e.target) && !elements.invoiceSearchResults.contains(e.target)) {
          if (!selectedInvoice) {
            elements.invoiceSearchResults.classList.add('hidden');
          }
        }
      });
      
      // Show search results when focusing on search input
      elements.invoiceSearch.addEventListener('focus', () => {
        if (elements.invoiceSearch.value.trim() && searchResults.length > 0) {
          elements.invoiceSearchResults.classList.remove('hidden');
        }
      });
      
      // Close modals on outside click
      [elements.poModal, elements.linkInvoiceModal, elements.deleteModal, elements.pdfModal].forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.classList.remove('show');
            if (modal === elements.poModal) {
              hideSuggestions();
              hideWarning();
            }
          }
        });
      });
      
      // Initialize
      initAutocomplete();
      filteredPOs = [...purchaseOrders];
      renderPurchaseOrders();
      
      // Initialize link invoice button as disabled
      elements.linkInvoiceBtn.disabled = true;
      elements.linkInvoiceBtn.style.opacity = '0.5';
    });
  </script>
</body>
</html>
