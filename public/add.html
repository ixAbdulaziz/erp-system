<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>إضافة فاتورة</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700&display=swap');
    
    :root {
      --primary: linear-gradient(135deg, #475569 0%, #334155 100%);
      --accent: linear-gradient(135deg, #64748b 0%, #475569 100%);
      --success: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      --info: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      --warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      --edit: linear-gradient(135deg, #64748b 0%, #475569 100%);
      --glass: rgba(15, 23, 42, 0.8);
      --glass-light: rgba(30, 41, 59, 0.6);
      --border: rgba(148, 163, 184, 0.1);
      --border-light: rgba(148, 163, 184, 0.2);
      --text: #f8fafc;
      --text-secondary: #e2e8f0;
      --text-muted: #94a3b8;
      --shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
      --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    
    * { box-sizing: border-box; }
    
    body { 
      font-family: 'Tajawal', sans-serif; 
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 40%, #334155 100%);
      background-attachment: fixed;
      color: var(--text);
      overflow-x: hidden;
    }
    
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.3); border-radius: 10px; }
    ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%); }
    
    @keyframes fadeInUp { 0% { opacity: 0; transform: translateY(30px); } 100% { opacity: 1; transform: translateY(0); } }
    @keyframes slideInRight { 0% { opacity: 0; transform: translateX(30px); } 100% { opacity: 1; transform: translateX(0); } }
    @keyframes gentleShimmer { 0% { background-position: -200% center; } 100% { background-position: 200% center; } }
    @keyframes gentleFloat { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-8px); } }
    @keyframes gentlePulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .fade-up { opacity: 0; transform: translateY(30px); animation: fadeInUp 0.8s ease forwards; }
    .slide-right { opacity: 0; transform: translateX(30px); animation: slideInRight 0.6s ease forwards; }
    
    /* Enhanced Sidebar */
    .sidebar {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%);
      backdrop-filter: blur(20px);
      border-left: 1px solid var(--border-light);
      box-shadow: var(--shadow);
    }
    
    .nav-link {
      transition: all 0.4s ease;
      position: relative;
      overflow: hidden;
      border-radius: 16px;
      margin: 4px 0;
      backdrop-filter: blur(10px);
    }
    
    .nav-link::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 0; height: 100%;
      background: var(--accent);
      transition: all 0.4s ease;
      z-index: -1;
      border-radius: 16px;
    }
    
    .nav-link:hover::before, .nav-link.active::before { width: 100%; }
    .nav-link:hover, .nav-link.active { 
      transform: translateX(-8px); 
      color: var(--text); 
      box-shadow: 0 8px 25px rgba(100, 116, 139, 0.3);
    }
    
    /* Enhanced Glass Cards */
    .glass-card, .form-container, .page-header {
      background: var(--glass);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 24px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    
    .glass-card::before, .form-container::before, .page-header::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: var(--accent);
      background-size: 200% 100%;
      animation: gentleShimmer 4s ease-in-out infinite;
    }
    
    /* Form Styling */
    .form-container {
      padding: 28px;
    }
    
    .form-container::before {
      background: linear-gradient(90deg, var(--accent), var(--primary), var(--info));
      background-size: 300% 100%;
      animation: gentleShimmer 6s ease-in-out infinite;
    }
    
    .form-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
      gap: 20px; 
      margin-bottom: 24px; 
    }
    
    .form-grid-full { grid-column: 1 / -1; }
    
    .input-group { 
      position: relative; 
      margin-bottom: 16px;
    }
    
    .input-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
      position: relative;
      transition: all 0.3s ease;
    }
    
    .input-label::after {
      content: '';
      position: absolute;
      bottom: -4px; right: 0;
      width: 0; height: 2px;
      background: var(--accent);
      transition: width 0.3s ease;
      border-radius: 2px;
    }
    
    /* Form Input Styling */
    input:not([type="submit"]):not([type="button"]):not([type="reset"]):not([type="file"]),
    textarea,
    .input-field {
      width: 100%;
      background: rgba(100, 116, 139, 0.15) !important;
      border: 2px solid rgba(100, 116, 139, 0.4) !important;
      border-radius: 12px;
      padding: 12px 16px;
      color: #e2e8f0 !important;
      font-size: 14px;
      font-weight: 500;
      backdrop-filter: blur(15px);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(100, 116, 139, 0.2) !important;
      text-align: right;
      direction: rtl;
      outline: none;
      font-family: 'Tajawal', sans-serif;
    }
    
    input:focus:not([type="submit"]):not([type="button"]):not([type="reset"]):not([type="file"]),
    textarea:focus,
    .input-field:focus {
      outline: none !important;
      background: rgba(100, 116, 139, 0.2) !important;
      border-color: rgba(100, 116, 139, 0.6) !important;
      box-shadow: 0 0 20px rgba(100, 116, 139, 0.4) !important;
      transform: translateY(-1px);
      color: #f1f5f9 !important;
    }
    
    input::placeholder, 
    textarea::placeholder,
    .input-field::placeholder {
      color: rgba(241, 245, 249, 0.7) !important;
      font-weight: 400;
      opacity: 0.9;
    }
    
    input:hover:not(:focus), 
    textarea:hover:not(:focus),
    .input-field:hover:not(:focus) {
      background: rgba(100, 116, 139, 0.18) !important;
      border-color: rgba(100, 116, 139, 0.5) !important;
      box-shadow: 0 6px 20px rgba(100, 116, 139, 0.25) !important;
    }
    
    input:focus + .input-label::after { width: 100%; }
    
    /* Textarea Styling */
    textarea.input-field {
      min-height: 80px;
      resize: vertical;
      line-height: 1.5;
    }
    
    /* Enhanced Autocomplete System */
    .autocomplete-container {
      position: relative;
      width: 100%;
    }
    
    .autocomplete-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      margin-top: 4px;
    }
    
    .autocomplete-suggestions.show {
      display: block;
      animation: fadeInUp 0.3s ease forwards;
    }
    
    .autocomplete-item {
      padding: 12px 16px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 1px solid rgba(100, 116, 139, 0.1);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      position: relative;
      overflow: hidden;
    }
    
    .autocomplete-item:last-child {
      border-bottom: none;
    }
    
    .autocomplete-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 0;
      height: 100%;
      background: linear-gradient(90deg, rgba(100, 116, 139, 0.1), rgba(100, 116, 139, 0.2));
      transition: width 0.3s ease;
      z-index: -1;
    }
    
    .autocomplete-item:hover::before,
    .autocomplete-item.highlighted::before {
      width: 100%;
    }
    
    .autocomplete-item:hover,
    .autocomplete-item.highlighted {
      background: rgba(100, 116, 139, 0.15);
      color: var(--text);
      transform: translateX(-2px);
    }
    
    .autocomplete-item:first-child {
      border-radius: 12px 12px 0 0;
    }
    
    .autocomplete-item:last-child {
      border-radius: 0 0 12px 12px;
    }
    
    .autocomplete-item:only-child {
      border-radius: 12px;
    }
    
    .autocomplete-icon {
      width: 16px;
      height: 16px;
      color: var(--text-muted);
      flex-shrink: 0;
    }
    
    .autocomplete-item:hover .autocomplete-icon,
    .autocomplete-item.highlighted .autocomplete-icon {
      color: var(--text-secondary);
    }
    
    .autocomplete-match {
      font-weight: 600;
      color: var(--text);
      background: rgba(100, 116, 139, 0.2);
      padding: 1px 3px;
      border-radius: 3px;
    }
    
    .autocomplete-warning {
      margin-top: 6px;
      padding: 8px 12px;
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 8px;
      color: #fbbf24;
      font-size: 13px;
      font-weight: 500;
      display: none;
      align-items: center;
      gap: 6px;
      animation: fadeInUp 0.4s ease forwards;
    }
    
    .autocomplete-warning.show {
      display: flex;
    }
    
    .autocomplete-warning::before {
      content: '⚠️';
      font-size: 14px;
    }
    
    .autocomplete-no-results {
      padding: 12px 16px;
      color: var(--text-muted);
      text-align: center;
      font-size: 13px;
      font-style: italic;
    }
    
    /* Success state when supplier is selected */
    .autocomplete-container.selected input {
      border-color: rgba(34, 197, 94, 0.6) !important;
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.3) !important;
    }
    
    .autocomplete-container.selected .input-label::after {
      background: var(--success);
      width: 100%;
    }
    
    /* Date Input */
    input[type="date"]::-webkit-calendar-picker-indicator { 
      filter: invert(0.7); 
      cursor: pointer; 
      padding: 4px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    input[type="date"]::-webkit-calendar-picker-indicator:hover {
      background: rgba(100, 116, 139, 0.2);
      transform: scale(1.1);
    }
    
    /* Enhanced File Upload */
    .file-container {
      position: relative;
      border-radius: 20px;
      background: rgba(100, 116, 139, 0.15);
      border: 2px dashed rgba(100, 116, 139, 0.4);
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.4s ease;
      overflow: hidden;
      backdrop-filter: blur(15px);
    }
    
    .file-container::before {
      content: '';
      position: absolute;
      top: -50%; left: -50%;
      width: 200%; height: 200%;
      background: radial-gradient(circle, rgba(100, 116, 139, 0.05) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.4s ease;
      animation: gentleFloat 6s ease-in-out infinite;
    }
    
    .file-container:hover {
      border-color: rgba(100, 116, 139, 0.6);
      background: rgba(100, 116, 139, 0.2);
      transform: translateY(-4px);
      box-shadow: 0 12px 30px rgba(100, 116, 139, 0.2);
    }
    
    .file-container:hover::before { opacity: 1; }
    
    .file-input {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      opacity: 0;
      cursor: pointer;
    }
    
    .file-content { 
      text-align: center; 
      pointer-events: none;
      position: relative;
      z-index: 2;
    }
    
    .file-icon {
      width: 48px; height: 48px;
      margin: 0 auto 10px;
      background: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: gentleFloat 4s ease-in-out infinite;
      box-shadow: 0 8px 20px rgba(100, 116, 139, 0.3);
    }
    
    /* Enhanced Button Styling */
    .modern-btn {
      background: var(--primary);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 16px 32px;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      justify-content: center;
      min-width: 180px;
      outline: none;
      user-select: none;
    }
    
    .modern-btn::before {
      content: '';
      position: absolute;
      top: 0; left: -100%;
      width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
      transition: left 0.6s ease;
      z-index: 1;
    }
    
    .modern-btn:hover::before { left: 100%; }
    .modern-btn:hover { 
      transform: translateY(-4px); 
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      border-color: var(--border-light);
      color: var(--text);
      text-decoration: none;
    }
    
    .modern-btn:active { 
      transform: translateY(-2px) scale(0.98); 
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.25);
      transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .modern-btn:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3), 0 20px 40px rgba(0, 0, 0, 0.3);
      transform: translateY(-4px);
    }
    
    .modern-btn .btn-icon {
      transition: all 0.3s ease;
      flex-shrink: 0;
    }
    
    .modern-btn:hover .btn-icon {
      transform: scale(1.1);
    }
    
    .modern-btn.success { 
      background: var(--success); 
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
    }
    
    .modern-btn.success:hover {
      box-shadow: 0 20px 40px rgba(16, 185, 129, 0.5);
      transform: translateY(-4px) scale(1.02);
    }
    
    .modern-btn.success:hover .btn-icon {
      filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.6));
    }
    
    .modern-btn.info { 
      background: var(--info); 
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
    }
    
    .modern-btn.info:hover {
      box-shadow: 0 20px 40px rgba(59, 130, 246, 0.5);
      transform: translateY(-4px) scale(1.02);
    }
    
    .modern-btn.info:hover .btn-icon {
      filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.6));
    }
    
    /* Enhanced Loading Animation */
    @keyframes loadingSlide {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    @keyframes loadingShimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }
    
    @keyframes loadingSquareBounce {
      0%, 100% { 
        transform: scale(1) rotate(0deg); 
        opacity: 1; 
        background: currentColor;
      }
      25% { 
        transform: scale(1.2) rotate(45deg); 
        opacity: 0.8; 
        background: rgba(255, 255, 255, 0.9);
      }
      50% { 
        transform: scale(1.1) rotate(90deg); 
        opacity: 0.9; 
        background: rgba(255, 255, 255, 0.7);
      }
      75% { 
        transform: scale(1.3) rotate(135deg); 
        opacity: 0.7; 
        background: rgba(255, 255, 255, 0.8);
      }
    }
    
    @keyframes buttonLoadingPulse {
      0%, 100% { 
        transform: scale(1); 
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
      }
      50% { 
        transform: scale(1.02); 
        box-shadow: 0 12px 35px rgba(99, 102, 241, 0.6);
      }
    }
    
    .loading-squares {
      display: inline-flex;
      gap: 3px;
      margin-right: 4px;
      align-items: center;
      vertical-align: middle;
    }
    
    .loading-squares span {
      width: 7px;
      height: 7px;
      background: currentColor;
      border-radius: 2px;
      animation: loadingSquareBounce 1.5s ease-in-out infinite;
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .loading-squares span:nth-child(1) { animation-delay: 0s; }
    .loading-squares span:nth-child(2) { animation-delay: 0.3s; }
    .loading-squares span:nth-child(3) { animation-delay: 0.6s; }
    
    .loading-progress {
      width: 20px;
      height: 5px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
      margin-right: 4px;
      display: inline-block;
      flex-shrink: 0;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .loading-progress::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 60%;
      background: linear-gradient(90deg, 
        rgba(255, 255, 255, 0.8), 
        rgba(255, 255, 255, 1), 
        rgba(255, 255, 255, 0.8)
      );
      border-radius: 3px;
      animation: loadingSlide 1.2s ease-in-out infinite;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
    }
    
    .modern-btn.loading {
      pointer-events: none;
      position: relative;
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
      border-color: rgba(99, 102, 241, 0.3);
      overflow: hidden;
      animation: buttonLoadingPulse 2s ease-in-out infinite;
      padding: 16px 24px 16px 32px;
      justify-content: flex-start;
    }
    
    .modern-btn.loading::before {
      background: linear-gradient(90deg, 
        transparent, 
        rgba(255,255,255,0.3), 
        transparent
      );
      background-size: 200% 100%;
      animation: loadingShimmer 2s ease-in-out infinite;
      left: 0;
      opacity: 1;
    }
    
    .modern-btn.loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, 
        rgba(255,255,255,0.1) 25%, 
        transparent 25%, 
        transparent 50%, 
        rgba(255,255,255,0.1) 50%, 
        rgba(255,255,255,0.1) 75%, 
        transparent 75%
      );
      background-size: 20px 20px;
      animation: loadingSlide 1s linear infinite;
      pointer-events: none;
    }
    
    .modern-btn.loading .btn-text {
      opacity: 1;
      transform: translateX(0);
      transition: all 0.3s ease;
      color: rgba(255, 255, 255, 0.95);
      font-weight: 600;
      position: relative;
      z-index: 3;
    }
    
    .modern-btn.loading .btn-icon {
      opacity: 1;
      transform: scale(1);
      transition: all 0.3s ease;
      position: relative;
      z-index: 3;
    }
    
    .modern-btn:disabled { 
      opacity: 0.5; 
      cursor: not-allowed; 
      transform: none !important; 
      pointer-events: none;
      filter: grayscale(0.3);
    }
    
    .modern-btn:disabled::before,
    .modern-btn:disabled::after {
      display: none;
    }
    
    /* Button Group */
    .btn-group {
      display: flex;
      gap: 20px;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
      position: relative;
      justify-content: center;
      flex-wrap: wrap;
      background: rgba(15, 23, 42, 0.4);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 24px;
      border: 1px solid var(--border);
    }
    
    .btn-group::before {
      content: '';
      position: absolute;
      top: 0; left: 50%;
      transform: translateX(-50%);
      width: 80px; height: 1px;
      background: var(--accent);
      border-radius: 1px;
    }
    
    /* Back Link Styling */
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      text-decoration: none;
      padding: 12px 20px;
      border-radius: 12px;
      background: rgba(100, 116, 139, 0.15);
      border: 1px solid var(--border);
      transition: all 0.4s ease;
      backdrop-filter: blur(10px);
      font-weight: 500;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }
    
    .back-link::before {
      content: '';
      position: absolute;
      top: 0; left: -100%;
      width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.6s ease;
    }
    
    .back-link:hover::before { left: 100%; }
    .back-link:hover {
      background: rgba(100, 116, 139, 0.2);
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(100, 116, 139, 0.3);
      border-color: var(--border-light);
      color: var(--text);
      text-decoration: none;
    }
    
    /* Header Icon */
    .header-icon {
      background: var(--accent);
      box-shadow: 0 8px 20px rgba(100, 116, 139, 0.3);
      animation: gentlePulse 4s ease-in-out infinite;
    }
    
    /* Success Animation */
    @keyframes peacefulSuccess {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
      70% { transform: scale(1.02); box-shadow: 0 0 0 15px rgba(34, 197, 94, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }
    
    .success-pulse { animation: peacefulSuccess 1s ease-out; }
    
    /* Notification System */
    .notification {
      position: fixed;
      top: 24px;
      right: 24px;
      padding: 16px 24px;
      border-radius: 12px;
      color: white;
      font-weight: 500;
      z-index: 10000;
      backdrop-filter: blur(20px);
      animation: fadeInUp 0.4s ease forwards;
      box-shadow: var(--shadow);
      max-width: 350px;
      border: 1px solid var(--border);
    }
    
    .notification.success { background: var(--success); }
    .notification.warning { background: var(--warning); }
    .notification.error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    .notification.info { background: var(--info); }
    
    /* Sparkles */
    .sparkle {
      position: absolute;
      width: 3px;
      height: 3px;
      background: var(--text-muted);
      border-radius: 50%;
      animation: gentleSparkle 3s ease-in-out infinite;
      opacity: 0.6;
    }
    
    @keyframes gentleSparkle {
      0%, 100% { opacity: 0; transform: scale(0); }
      50% { opacity: 0.8; transform: scale(1); }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .form-container, .page-header { padding: 20px 16px; }
      .form-grid { grid-template-columns: 1fr; gap: 16px; }
      .btn-group { 
        flex-direction: column; 
        gap: 16px;
        align-items: center;
        padding: 20px 16px;
        margin-top: 24px;
      }
      input, textarea, .input-field { padding: 12px 14px; font-size: 14px; }
      .modern-btn { 
        padding: 14px 20px 14px 24px; 
        font-size: 14px;
        min-width: 200px;
        width: 100%;
        max-width: 300px;
        gap: 6px;
      }
      
      .modern-btn.loading {
        padding: 14px 16px 14px 20px;
        justify-content: flex-start;
      }
      .file-container { min-height: 100px; }
      .file-icon { width: 40px; height: 40px; }
      .input-group { margin-bottom: 12px; }
      main { padding: 16px; }
      
      .autocomplete-suggestions {
        max-height: 150px;
        font-size: 14px;
      }
      
      .autocomplete-item {
        padding: 10px 14px;
      }
      
      .autocomplete-warning {
        font-size: 12px;
        padding: 6px 10px;
      }
    }
  </style>
</head>
<body class="flex bg-gray-900 text-gray-100 min-h-screen">
  <!-- Sidebar -->
  <aside class="sidebar w-64 flex flex-col p-8 hidden md:block">
    <div class="text-center mb-12">
      <h1 class="text-3xl font-bold bg-gradient-to-r from-slate-400 via-slate-300 to-slate-500 bg-clip-text text-transparent">المشتريات</h1>
      <div class="w-20 h-1 bg-gradient-to-r from-slate-500 to-slate-400 mx-auto mt-3 rounded-full"></div>
    </div>
    <nav class="space-y-4 flex-1">
      <a href="home.html" class="nav-link block py-4 px-6">
        <span class="relative z-10 flex items-center gap-3">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
          </svg>
          لوحة المعلومات
        </span>
      </a>
      <a href="add.html" class="nav-link active block py-4 px-6">
        <span class="relative z-10 flex items-center gap-3">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          إضافة فاتورة
        </span>
      </a>
      <a href="view.html" class="nav-link block py-4 px-6">
        <span class="relative z-10 flex items-center gap-3">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          عرض الفواتير
        </span>
      </a>
      <a href="purchase-orders.html" class="nav-link block py-4 px-6">
        <span class="relative z-10 flex items-center gap-3">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
          </svg>
          أوامر الشراء
        </span>
      </a>
    </nav>
  </aside>
  
  <!-- Main Content -->
  <main class="flex-1 p-8 space-y-6">
    <!-- Page Header -->
    <section class="page-header fade-up">
      <div class="flex items-center justify-between flex-wrap gap-4">
        <div>
          <h2 class="text-3xl font-bold bg-gradient-to-r from-slate-300 via-slate-200 to-slate-400 bg-clip-text text-transparent mb-2">إضافة فاتورة جديدة</h2>
          <p class="text-slate-400 text-base">املأ البيانات أدناه لإضافة فاتورة جديدة إلى النظام</p>
        </div>
        <div class="hidden md:block relative">
          <div class="w-16 h-16 header-icon rounded-2xl flex items-center justify-center">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
          </div>
          <div class="sparkle" style="top: 8px; right: 8px; animation-delay: 0.5s;"></div>
          <div class="sparkle" style="bottom: 8px; left: 8px; animation-delay: 2s;"></div>
        </div>
      </div>
    </section>

    <!-- Form -->
    <section class="form-container fade-up" style="animation-delay: 0.2s;">
      <form onsubmit="saveInvoice(); return false;">
        <div class="form-grid">
          <div class="input-group">
            <label for="supplier" class="input-label">اسم المورد</label>
            <div class="autocomplete-container">
              <input id="supplier" type="text" placeholder="أدخل اسم المورد" required autocomplete="off" />
              <div id="supplierSuggestions" class="autocomplete-suggestions"></div>
              <div id="supplierWarning" class="autocomplete-warning"></div>
            </div>
          </div>
          <div class="input-group">
            <label for="type" class="input-label">نوع الفاتورة</label>
            <input id="type" type="text" placeholder="أدخل نوع الفاتورة" required />
          </div>
          <div class="input-group">
            <label for="category" class="input-label">اسم الفئة</label>
            <input id="category" type="text" placeholder="أدخل اسم الفئة" />
          </div>
          <div class="input-group">
            <label for="invoiceNumber" class="input-label">رقم الفاتورة</label>
            <input id="invoiceNumber" type="text" placeholder="أدخل رقم الفاتورة" required />
          </div>
          <div class="input-group">
            <label for="date" class="input-label">التاريخ</label>
            <input id="date" type="date" required />
          </div>
          <div class="input-group">
            <label for="amountBeforeTax" class="input-label">المبلغ بدون ضريبة</label>
            <input id="amountBeforeTax" type="text" placeholder="0.00" required />
          </div>
          <div class="input-group">
            <label for="taxAmount" class="input-label">مبلغ الضريبة</label>
            <input id="taxAmount" type="text" placeholder="0.00" required />
          </div>
          <div class="input-group">
            <label for="totalAmount" class="input-label">الإجمالي</label>
            <input id="totalAmount" type="text" placeholder="0.00" required />
          </div>
          <div class="input-group form-grid-full">
            <label for="notes" class="input-label">ملاحظات (اختياري)</label>
            <textarea id="notes" rows="3" placeholder="أضف أي ملاحظات حول الفاتورة..." class="input-field"></textarea>
          </div>
          <div class="input-group form-grid-full">
            <label for="pdfFile" class="input-label">ملف الفاتورة (PDF أو صورة)</label>
            <div class="file-container" id="fileContainer">
              <input id="pdfFile" type="file" accept="application/pdf,image/*" required class="file-input" />
              <div class="file-content" id="fileContent">
                <div class="file-icon">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                  </svg>
                </div>
                <h3 class="text-base font-semibold text-slate-200 mb-1">اختر ملف PDF أو صورة</h3>
                <p class="text-sm text-slate-400 mb-1">اسحب الملف هنا أو انقر للاختيار</p>
                <p class="text-xs text-slate-500">يدعم PDF, JPG, PNG, JPEG • الحد الأقصى 10MB</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="btn-group">
          <button type="button" id="analyzeBtn" class="modern-btn info">
            <svg class="w-6 h-6 btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
            <span id="analyzeText" class="btn-text">تحليل الفاتورة</span>
          </button>
          <button type="submit" id="saveBtn" class="modern-btn success">
            <svg class="w-6 h-6 btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span class="btn-text">حفظ الفاتورة</span>
          </button>
        </div>
      </form>
    </section>

    <!-- Back Link -->
    <div class="text-center fade-up" style="animation-delay: 0.4s;">
      <a href="home.html" class="back-link">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        العودة إلى الصفحة الرئيسية
      </a>
    </div>
  </main>

  <script>
    // Initialize elements
    const elements = {
      file: document.getElementById('pdfFile'),
      container: document.getElementById('fileContainer'),
      content: document.getElementById('fileContent'),
      analyzeBtn: document.getElementById('analyzeBtn'),
      analyzeText: document.getElementById('analyzeText'),
      saveBtn: document.getElementById('saveBtn'),
      // Autocomplete elements
      supplierInput: document.getElementById('supplier'),
      supplierSuggestions: document.getElementById('supplierSuggestions'),
      supplierWarning: document.getElementById('supplierWarning'),
      supplierContainer: document.querySelector('.autocomplete-container')
    };

    // Enhanced Autocomplete System
    let suppliers = [];
    let selectedSupplier = null;
    let highlightedIndex = -1;
    let searchTimeout;
    
    // Load suppliers from localStorage
    function loadSuppliers() {
      const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
      const uniqueSuppliers = [...new Set(invoices.map(inv => inv.supplier?.trim()).filter(Boolean))];
      
      // Add some sample suppliers for demonstration
      const sampleSuppliers = [
        'شركة الأتقان للسفر والسياحة',
        'مؤسسة البناء الحديث',
        'شركة التقنيات المتقدمة',
        'مكتب الاستشارات الهندسية',
        'شركة النقل السريع',
        'مؤسسة الخدمات الطبية',
        'شركة الإعلانات الرقمية',
        'مكتب المحاماة والاستشارات القانونية',
        'شركة الصيانة الشاملة',
        'مؤسسة التعليم والتدريب'
      ];
      
      suppliers = [...new Set([...uniqueSuppliers, ...sampleSuppliers])].sort();
    }
    
    // Fuzzy search function
    function fuzzySearch(query, text) {
      const queryLower = query.toLowerCase();
      const textLower = text.toLowerCase();
      
      // Direct match
      if (textLower.includes(queryLower)) {
        return { score: 100, match: true };
      }
      
      // Character-by-character matching
      let score = 0;
      let queryIndex = 0;
      
      for (let i = 0; i < textLower.length && queryIndex < queryLower.length; i++) {
        if (textLower[i] === queryLower[queryIndex]) {
          score += 2;
          queryIndex++;
        }
      }
      
      // Bonus for matching at word boundaries
      const words = textLower.split(/\s+/);
      for (const word of words) {
        if (word.startsWith(queryLower)) {
          score += 10;
          break;
        }
      }
      
      return { 
        score: score, 
        match: queryIndex === queryLower.length && score > queryLower.length 
      };
    }
    
    // Search suppliers
    function searchSuppliers(query) {
      if (query.length < 2) return [];
      
      const results = suppliers
        .map(supplier => {
          const searchResult = fuzzySearch(query, supplier);
          return {
            name: supplier,
            score: searchResult.score,
            match: searchResult.match
          };
        })
        .filter(item => item.match)
        .sort((a, b) => b.score - a.score)
        .slice(0, 8);
      
      return results;
    }
    
    // Highlight matching text
    function highlightMatch(text, query) {
      if (!query) return text;
      
      const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      return text.replace(regex, '<span class="autocomplete-match">$1</span>');
    }
    
    // Show suggestions
    function showSuggestions(suggestions) {
      const container = elements.supplierSuggestions;
      
      if (suggestions.length === 0) {
        container.innerHTML = '<div class="autocomplete-no-results">لا توجد نتائج مطابقة</div>';
        container.classList.add('show');
        return;
      }
      
      const suggestionHTML = suggestions.map((item, index) => {
        const highlightedName = highlightMatch(item.name, elements.supplierInput.value);
        return `
          <div class="autocomplete-item" data-index="${index}" data-supplier="${item.name}">
            <svg class="autocomplete-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H3m2 0h4M9 7h6m-6 4h6m-6 4h6m-6 4h6"></path>
            </svg>
            <span>${highlightedName}</span>
          </div>
        `;
      }).join('');
      
      container.innerHTML = suggestionHTML;
      container.classList.add('show');
      highlightedIndex = -1;
    }
    
    // Hide suggestions
    function hideSuggestions() {
      elements.supplierSuggestions.classList.remove('show');
      highlightedIndex = -1;
    }
    
    // Show warning
    function showWarning(message) {
      elements.supplierWarning.textContent = message;
      elements.supplierWarning.classList.add('show');
      
      setTimeout(() => {
        elements.supplierWarning.classList.remove('show');
      }, 5000);
    }
    
    // Hide warning
    function hideWarning() {
      elements.supplierWarning.classList.remove('show');
    }
    
    // Select supplier
    function selectSupplier(supplierName) {
      elements.supplierInput.value = supplierName;
      selectedSupplier = supplierName;
      elements.supplierContainer.classList.add('selected');
      hideSuggestions();
      hideWarning();
      
      // Add success animation
      elements.supplierInput.style.animation = 'peacefulSuccess 0.6s ease-out';
      setTimeout(() => {
        elements.supplierInput.style.animation = '';
      }, 600);
    }
    
    // Handle keyboard navigation
    function handleKeyboardNavigation(e) {
      const items = elements.supplierSuggestions.querySelectorAll('.autocomplete-item');
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
        updateHighlight(items);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        highlightedIndex = Math.max(highlightedIndex - 1, -1);
        updateHighlight(items);
      } else if (e.key === 'Enter' && highlightedIndex >= 0) {
        e.preventDefault();
        const selectedItem = items[highlightedIndex];
        if (selectedItem) {
          selectSupplier(selectedItem.dataset.supplier);
        }
      } else if (e.key === 'Escape') {
        hideSuggestions();
      }
    }
    
    // Update highlight
    function updateHighlight(items) {
      items.forEach((item, index) => {
        if (index === highlightedIndex) {
          item.classList.add('highlighted');
          item.scrollIntoView({ block: 'nearest' });
        } else {
          item.classList.remove('highlighted');
        }
      });
    }
    
    // Initialize autocomplete
    function initAutocomplete() {
      loadSuppliers();
      
      // Input event handler
      elements.supplierInput.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        selectedSupplier = null;
        elements.supplierContainer.classList.remove('selected');
        
        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }
        
        if (query.length < 2) {
          hideSuggestions();
          hideWarning();
          return;
        }
        
        // Show loading state
        elements.supplierSuggestions.innerHTML = '<div class="autocomplete-loading">جاري البحث...</div>';
        elements.supplierSuggestions.classList.add('show');
        
        // Debounce search
        searchTimeout = setTimeout(() => {
          const suggestions = searchSuppliers(query);
          showSuggestions(suggestions);
          
          if (query.length > 3 && suggestions.length === 0) {
            showWarning('لم يتم العثور على موردين مطابقين. تحقق من الاسم لتفادي التكرار.');
          } else if (query.length > 3 && !suggestions.some(s => s.name.toLowerCase() === query.toLowerCase())) {
            showWarning('تحقق من الأسماء المقترحة لتفادي تكرار الموردين.');
          } else {
            hideWarning();
          }
        }, 300);
      });
      
      // Keyboard navigation
      elements.supplierInput.addEventListener('keydown', handleKeyboardNavigation);
      
      // Click handler for suggestions
      elements.supplierSuggestions.addEventListener('click', (e) => {
        const item = e.target.closest('.autocomplete-item');
        if (item) {
          selectSupplier(item.dataset.supplier);
        }
      });
      
      // Focus handler
      elements.supplierInput.addEventListener('focus', () => {
        if (elements.supplierInput.value.length >= 2) {
          const suggestions = searchSuppliers(elements.supplierInput.value);
          showSuggestions(suggestions);
        }
      });
      
      // Blur handler
      elements.supplierInput.addEventListener('blur', () => {
        setTimeout(() => {
          hideSuggestions();
        }, 200);
      });
      
      // Prevent form submission when selecting from autocomplete
      elements.supplierSuggestions.addEventListener('mousedown', (e) => {
        e.preventDefault();
      });
    }
    
    // Enhanced button effects
    function setButtonLoading(button, isLoading, loadingText = 'جاري المعالجة...') {
      const icon = button.querySelector('.btn-icon');
      const text = button.querySelector('.btn-text');
      
      if (isLoading) {
        button.classList.add('loading');
        button.disabled = true;
        
        if (icon) {
          icon.innerHTML = `<div class="loading-progress"></div>`;
        }
        
        if (text) {
          text.innerHTML = `
            <div class="loading-squares">
              <span></span>
              <span></span>
              <span></span>
            </div>${loadingText}
          `;
        }
      } else {
        button.classList.remove('loading');
        button.disabled = false;
      }
    }
    
    function setButtonSuccess(button, successText, originalText, duration = 2000) {
      const icon = button.querySelector('.btn-icon');
      const text = button.querySelector('.btn-text');
      
      button.classList.remove('loading');
      button.classList.add('success-pulse');
      
      if (icon) {
        icon.innerHTML = `
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        `;
      }
      
      if (text) {
        text.innerHTML = `
          <div style="display: inline-flex; align-items: center; gap: 6px;">
            <div style="width: 6px; height: 6px; background: #10b981; border-radius: 2px; box-shadow: 0 0 8px #10b981;"></div>${successText}
          </div>
        `;
      }
      
      setTimeout(() => {
        button.classList.remove('success-pulse');
        if (text) {
          text.textContent = originalText;
        }
        if (icon && button.id === 'analyzeBtn') {
          icon.innerHTML = `
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
          `;
        } else if (icon && button.id === 'saveBtn') {
          icon.innerHTML = `
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          `;
        }
      }, duration);
    }

    // Format numbers
    const formatNumber = num => isNaN(num) ? '' : new Intl.NumberFormat('en-US').format(num);

    // Enhanced file handling
    elements.file.addEventListener('change', e => {
      if (e.target.files.length) {
        const file = e.target.files[0];
        const fileName = file.name;
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        const fileType = file.type;
        
        // Check file size (10MB limit)
        if (file.size > 10 * 1024 * 1024) {
          showNotification('حجم الملف كبير جداً. يرجى اختيار ملف أصغر من 10 ميجابايت', 'warning');
          elements.file.value = '';
          return;
        }
        
        // Determine file icon and type
        let fileTypeText = '';
        if (fileType === 'application/pdf') {
          fileTypeText = 'PDF';
        } else if (fileType.startsWith('image/')) {
          fileTypeText = 'صورة';
        }
        
        elements.content.innerHTML = `
          <div class="file-icon" style="background: var(--success); animation: gentlePulse 2s ease-in-out infinite;">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
          <h3 class="text-base font-semibold text-green-300 mb-1">✓ تم اختيار الملف</h3>
          <p class="text-sm text-slate-300 mb-1">${fileName} (${fileTypeText})</p>
          <p class="text-xs text-slate-400">الحجم: ${fileSize} MB • انقر لتغيير الملف</p>
        `;
        elements.container.style.borderColor = 'rgba(34, 197, 94, 0.6)';
        elements.container.style.background = 'rgba(34, 197, 94, 0.1)';
      }
    });

    // Enhanced Drag & Drop
    ['dragover', 'dragleave', 'drop'].forEach(event => {
      elements.container.addEventListener(event, e => {
        e.preventDefault();
        if (event === 'dragover') {
          elements.container.style.borderColor = 'rgba(100, 116, 139, 0.6)';
          elements.container.style.transform = 'translateY(-2px)';
          elements.container.style.background = 'rgba(100, 116, 139, 0.2)';
        } else if (event === 'drop' && e.dataTransfer.files.length) {
          const file = e.dataTransfer.files[0];
          const fileType = file.type;
          
          if (fileType === 'application/pdf' || fileType.startsWith('image/')) {
            elements.file.files = e.dataTransfer.files;
            elements.file.dispatchEvent(new Event('change'));
          } else {
            showNotification('يرجى اختيار ملف PDF أو صورة فقط', 'warning');
          }
        }
        if (event !== 'dragover') {
          elements.container.style.borderColor = 'rgba(100, 116, 139, 0.4)';
          elements.container.style.transform = 'translateY(0)';
          elements.container.style.background = 'rgba(100, 116, 139, 0.15)';
        }
      });
    });

    // Enhanced AI Invoice Analysis
    elements.analyzeBtn.addEventListener('click', async () => {
      if (!elements.file.files.length) {
        showNotification('اختر ملف PDF أو صورة أولاً', 'warning');
        return;
      }
      
      const file = elements.file.files[0];
      const fileType = file.type;
      
      if (fileType !== 'application/pdf' && !fileType.startsWith('image/')) {
        showNotification('يرجى اختيار ملف PDF أو صورة صالحة', 'warning');
        return;
      }
      
      if (file.size > 10 * 1024 * 1024) {
        showNotification('حجم الملف كبير جداً. يرجى اختيار ملف أصغر من 10 ميجابايت', 'warning');
        return;
      }
      
      setButtonLoading(elements.analyzeBtn, true, 'جاري تحليل الفاتورة بذكاء...');
      
      try {
        const formData = new FormData();
        formData.append('invoice', file);
        formData.append('fileType', fileType.startsWith('image/') ? 'image' : 'pdf');
        
        const res = await fetch('/api/analyze-invoice', { 
          method: 'POST', 
          body: formData
        });
        
        if (!res.ok) {
          console.log('خادم التحليل غير متاح، جاري المحاكاة...');
          
          // Smart invoice type detection based on filename
          const fileName = file.name.toLowerCase();
          let smartType = 'فاتورة عامة';
          
          if (fileName.includes('travel') || fileName.includes('tourism') || fileName.includes('سفر') || fileName.includes('سياحة')) {
            smartType = 'فاتورة سفر وسياحة';
          } else if (fileName.includes('tax') || fileName.includes('ضريبة') || fileName.includes('vat')) {
            smartType = 'فاتورة ضريبية';
          } else if (fileName.includes('service') || fileName.includes('خدمة') || fileName.includes('خدمات')) {
            smartType = 'فاتورة خدمات';
          } else if (fileName.includes('purchase') || fileName.includes('buy') || fileName.includes('مشتريات') || fileName.includes('شراء')) {
            smartType = 'فاتورة مشتريات';
          } else if (fileName.includes('consulting') || fileName.includes('استشار')) {
            smartType = 'فاتورة استشارات';
          } else if (fileName.includes('medical') || fileName.includes('طبي') || fileName.includes('علاج')) {
            smartType = 'فاتورة طبية';
          } else if (fileName.includes('education') || fileName.includes('تعليم') || fileName.includes('دراسة')) {
            smartType = 'فاتورة تعليمية';
          } else if (fileName.includes('transport') || fileName.includes('مواصلات') || fileName.includes('نقل')) {
            smartType = 'فاتورة مواصلات';
          } else if (fileName.includes('marketing') || fileName.includes('ads') || fileName.includes('إعلان') || fileName.includes('تسويق')) {
            smartType = 'فاتورة إعلانات وتسويق';
          } else if (fileName.includes('maintenance') || fileName.includes('repair') || fileName.includes('صيانة') || fileName.includes('إصلاح')) {
            smartType = 'فاتورة صيانة وإصلاح';
          }
          
          const simulatedData = {
            supplier: 'اسم المورد (يحتاج API)',
            type: smartType,
            invoiceNumber: 'INV001',
            date: new Date().toISOString().split('T')[0],
            amountBeforeTax: '1000',
            taxAmount: '150',
            totalAmount: '1150'
          };
          
          showNotification('تم تحديد نوع الفاتورة بذكاء. للحصول على تحليل كامل، قم بإعداد خادم الـ AI', 'info');
          
          const fields = [
            { id: 'supplier', value: simulatedData.supplier },
            { id: 'type', value: simulatedData.type },
            { id: 'category', value: '' },
            { id: 'invoiceNumber', value: simulatedData.invoiceNumber },
            { id: 'date', value: simulatedData.date },
            { id: 'amountBeforeTax', value: formatNumber(simulatedData.amountBeforeTax) },
            { id: 'taxAmount', value: formatNumber(simulatedData.taxAmount) },
            { id: 'totalAmount', value: formatNumber(simulatedData.totalAmount) }
          ];
          
          fields.forEach((field, i) => {
            setTimeout(() => {
              const el = document.getElementById(field.id);
              el.value = field.value;
              el.style.animation = 'peacefulSuccess 0.6s ease-out';
              el.style.borderColor = 'rgba(34, 197, 94, 0.6)';
              setTimeout(() => {
                el.style.animation = '';
                el.style.borderColor = 'rgba(100, 116, 139, 0.4)';
              }, 600);
            }, i * 100);
          });
          
          setButtonLoading(elements.analyzeBtn, false);
          setButtonSuccess(elements.analyzeBtn, 'تم التحليل التجريبي', 'تحليل الفاتورة');
          return;
        }
        
        const json = await res.json();
        const data = json.data;
        
        const fields = [
          { id: 'supplier', value: data.supplier || '' },
          { id: 'type', value: data.type || '' },
          { id: 'category', value: '' },
          { id: 'invoiceNumber', value: data.invoiceNumber || '' },
          { id: 'date', value: data.date || '' },
          { id: 'amountBeforeTax', value: formatNumber(data.amountBeforeTax) || '' },
          { id: 'taxAmount', value: formatNumber(data.taxAmount) || '' },
          { id: 'totalAmount', value: formatNumber(data.totalAmount) || '' }
        ];
        
        fields.forEach((field, i) => {
          setTimeout(() => {
            const el = document.getElementById(field.id);
            el.value = field.value;
            el.style.animation = 'peacefulSuccess 0.6s ease-out';
            el.style.borderColor = 'rgba(34, 197, 94, 0.6)';
            setTimeout(() => {
              el.style.animation = '';
              el.style.borderColor = 'rgba(100, 116, 139, 0.4)';
            }, 600);
          }, i * 100);
        });
        
        setButtonLoading(elements.analyzeBtn, false);
        setButtonSuccess(elements.analyzeBtn, 'تم التحليل الذكي بنجاح', 'تحليل الفاتورة');
        showNotification('تم تحليل الفاتورة وتحديد نوعها بذكاء', 'success');
        
      } catch (err) {
        console.error(err);
        setButtonLoading(elements.analyzeBtn, false);
        
        elements.analyzeBtn.classList.remove('loading');
        elements.analyzeBtn.classList.add('error-state');
        
        const text = elements.analyzeBtn.querySelector('.btn-text');
        const icon = elements.analyzeBtn.querySelector('.btn-icon');
        
        if (icon) {
          icon.innerHTML = `
            <div style="width: 24px; height: 5px; background: rgba(239, 68, 68, 0.3); border-radius: 3px; position: relative; overflow: hidden; border: 1px solid rgba(239, 68, 68, 0.5);">
              <div style="position: absolute; top: 0; left: 0; height: 100%; width: 100%; background: #ef4444; border-radius: 3px; animation: gentlePulse 1s ease-in-out infinite;"></div>
            </div>
          `;
        }
        
        if (text) {
          text.innerHTML = `
            <div style="display: inline-flex; align-items: center; gap: 6px;">
              <div style="width: 6px; height: 6px; background: #ef4444; border-radius: 2px; box-shadow: 0 0 8px #ef4444; animation: gentlePulse 1s ease-in-out infinite;"></div>خطأ في التحليل
            </div>
          `;
        }
        
        setTimeout(() => {
          elements.analyzeBtn.classList.remove('error-state');
          if (text) text.textContent = 'تحليل الفاتورة';
          if (icon) {
            icon.innerHTML = `
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
              </svg>
            `;
          }
        }, 2500);
        
        if (err.message.includes('fetch')) {
          showNotification('لا يمكن الاتصال بخدمة التحليل. تأكد من تشغيل الخادم.', 'error');
        } else {
          showNotification(err.message, 'error');
        }
      }
    });

    // استبدل الدالة القديمة بهذه الدالة الجديدة
function saveInvoice() {
  const fileInput = document.getElementById('pdfFile');
  const file = fileInput.files[0];

  // التحقق من وجود الحقول المطلوبة
  const supplier = document.getElementById('supplier').value.trim();
  const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
  const date = document.getElementById('date').value;
  const totalAmount = parseFloat(document.getElementById('totalAmount').value.replace(/,/g, ''));

  if (!supplier || !invoiceNumber || !date || isNaN(totalAmount)) {
    // استخدمنا showNotification الموجودة لديك بالفعل
    showNotification('يرجى ملء جميع الحقول المطلوبة: المورد، رقم الفاتورة، التاريخ، والإجمالي', 'warning');
    return; // إيقاف التنفيذ
  }

  const invoiceData = {
    supplier: supplier,
    type: document.getElementById('type').value.trim(),
    category: document.getElementById('category').value.trim(),
    invoice_number: invoiceNumber,
    invoice_date: date,
    amount_before_tax: parseFloat(document.getElementById('amountBeforeTax').value.replace(/,/g, '')) || 0,
    tax_amount: parseFloat(document.getElementById('taxAmount').value.replace(/,/g, '')) || 0,
    total_amount: totalAmount,
    notes: document.getElementById('notes').value.trim(),
    file_name: file ? file.name : null,
    file_data: null // سنقوم بملئها لاحقًا
  };

  // دالة لإرسال البيانات إلى الخادم
  const sendDataToServer = async (data) => {
    // تفعيل زر الحفظ وإظهار التحميل
    const saveBtn = document.getElementById('saveBtn');
    setButtonLoading(saveBtn, true, 'جاري الحفظ...');

    try {
      const response = await fetch('/api/invoices', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error('فشل الاتصال بالخادم');
      }

      // نجاح!
      setButtonSuccess(saveBtn, 'تم الحفظ بنجاح', 'حفظ الفاتورة', 1200);
      showNotification('تم حفظ الفاتورة بنجاح في قاعدة البيانات', 'success');

      setTimeout(() => {
        window.location.href = 'view.html'; // توجيه المستخدم لصفحة عرض الفواتير
      }, 1200);

    } catch (error) {
      console.error('Error:', error);
      showNotification('حدث خطأ أثناء حفظ الفاتورة', 'error');
      // إعادة الزر لوضعه الطبيعي عند الفشل
      setButtonLoading(document.getElementById('saveBtn'), false);
    }
  };

  // التحقق إذا كان هناك ملف مرفق
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      invoiceData.file_data = e.target.result; // إضافة بيانات الملف (base64)
      sendDataToServer(invoiceData); // إرسال البيانات بعد قراءة الملف
    };
    reader.onerror = function() {
      showNotification('حدث خطأ في قراءة الملف', 'error');
    };
    reader.readAsDataURL(file); // بدء قراءة الملف
  } else {
    sendDataToServer(invoiceData); // إرسال البيانات مباشرة بدون ملف
  }
}
    // Enhanced notification system
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateY(-20px)';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Add gentle sparkles
    function createSparkles() {
      const container = document.querySelector('.page-header');
      for (let i = 0; i < 3; i++) {
        setTimeout(() => {
          const sparkle = document.createElement('div');
          sparkle.className = 'sparkle';
          sparkle.style.left = Math.random() * 100 + '%';
          sparkle.style.top = Math.random() * 100 + '%';
          sparkle.style.animationDelay = Math.random() * 3 + 's';
          container.appendChild(sparkle);
          
          setTimeout(() => sparkle.remove(), 3000);
        }, i * 1000);
      }
    }

    // Initialize on DOM load
    document.addEventListener('DOMContentLoaded', () => {
      initAutocomplete();
      setInterval(createSparkles, 8000);
    });
  </script>
</body>
</html>
