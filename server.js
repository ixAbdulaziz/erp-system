import 'dotenv/config';
import express from 'express';
import multer from 'multer';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import pdfParse from 'pdf-parse';
import Tesseract from 'tesseract.js';
import OpenAI from 'openai';

// Ø¥Ù†Ø´Ø§Ø¡ __dirname Ù„Ù„Ù€ ES modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const port = process.env.PORT || 3000;

console.log(`ğŸš€ Starting server on port: ${port}`);

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ù…Ø§ÙŠØ©
const AUTH_USERNAME = process.env.AUTH_USERNAME || 'admin';
const AUTH_PASSWORD = process.env.AUTH_PASSWORD || 'password123';

console.log(`ğŸ” Authentication enabled for user: ${AUTH_USERNAME}`);

// Basic Authentication Middleware
const authenticateUser = (req, res, next) => {
  const authHeader = req.headers.authorization;
  
  if (!authHeader) {
    res.set('WWW-Authenticate', 'Basic realm="ERP System"');
    return res.status(401).send(`
      <html>
        <head>
          <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨</title>
          <meta charset="utf-8">
        </head>
        <body style="font-family: Arial; text-align: center; padding: 50px;">
          <h1>ğŸ”’ Ù†Ø¸Ø§Ù… ERP Ù…Ø­Ù…ÙŠ</h1>
          <p>ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</p>
          <p style="color: #666;">Ø³ÙŠØªÙ… Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
        </body>
      </html>
    `);
  }

  const base64Credentials = authHeader.split(' ')[1];
  const credentials = Buffer.from(base64Credentials, 'base64').toString('ascii');
  const [username, password] = credentials.split(':');

  if (username === AUTH_USERNAME && password === AUTH_PASSWORD) {
    console.log(`âœ… User authenticated: ${username}`);
    next();
  } else {
    console.log(`âŒ Failed authentication attempt: ${username}`);
    res.set('WWW-Authenticate', 'Basic realm="ERP System"');
    return res.status(401).send(`
      <html>
        <head>
          <title>Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>
          <meta charset="utf-8">
        </head>
        <body style="font-family: Arial; text-align: center; padding: 50px;">
          <h1>âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
          <p>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©</p>
          <button onclick="location.reload()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
        </body>
      </html>
    `);
  }
};

// Ø¥Ø¹Ø¯Ø§Ø¯ CORS
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*');
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept, Authorization');
  if (req.method === 'OPTIONS') {
    res.sendStatus(200);
  } else {
    next();
  }
});

app.use(express.json());
app.use(express.static('public'));

// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª (Ù…Ø§ Ø¹Ø¯Ø§ health check)
app.use((req, res, next) => {
  // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ health check Ø¨Ø¯ÙˆÙ† Ø­Ù…Ø§ÙŠØ© Ù„Ù„Ù€ Railway
  if (req.path === '/health') {
    return next();
  }
  
  // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø¹Ù„Ù‰ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
  authenticateUser(req, res, next);
});

// Ø¥Ø¹Ø¯Ø§Ø¯ multer
const upload = multer({ 
  dest: 'uploads/',
  limits: { fileSize: 10 * 1024 * 1024 },
  fileFilter: (req, file, cb) => {
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
    if (allowedTypes.includes(file.mimetype)) {
      cb(null, true);
    } else {
      cb(new Error('Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…'), false);
    }
  }
});

// ØªØ­Ù‚Ù‚ Ù…Ù† API key
const openai = process.env.OPENAI_API_KEY ? new OpenAI({ apiKey: process.env.OPENAI_API_KEY }) : null;
const modelName = process.env.OPENAI_MODEL || 'gpt-4';

// Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
app.get('/', (req, res) => {
  try {
    const homePath = path.join(__dirname, 'public', 'home.html');
    if (fs.existsSync(homePath)) {
      res.sendFile(homePath);
    } else {
      res.send(`
        <html>
        <head>
          <title>ERP System</title>
          <meta charset="utf-8">
        </head>
        <body style="font-family: Arial; padding: 20px;">
          <h1>ğŸ‰ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… ERP Ø§Ù„Ù…Ø­Ù…ÙŠ</h1>
          <p>âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!</p>
          <p>Ø§Ù„Ù…Ù„Ù home.html ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…Ø¬Ù„Ø¯ public</p>
          <hr>
          <p><a href="/ping">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø®Ø§Ø¯Ù…</a></p>
          <p><a href="/logout">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></p>
        </body>
        </html>
      `);
    }
  } catch (error) {
    console.error('Error serving home page:', error);
    res.status(500).send('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©');
  }
});

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
app.get('/logout', (req, res) => {
  res.set('WWW-Authenticate', 'Basic realm="ERP System"');
  res.status(401).send(`
    <html>
      <head>
        <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</title>
        <meta charset="utf-8">
      </head>
      <body style="font-family: Arial; text-align: center; padding: 50px;">
        <h1>ğŸ‘‹ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</h1>
        <p>Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø¸Ø§Ù… ERP</p>
        <a href="/">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      </body>
    </html>
  `);
});

// Ù†Ù‚Ø·Ø© ÙØ­Øµ Ø§Ù„Ø®Ø§Ø¯Ù…
app.get('/ping', (req, res) => {
  res.json({ 
    status: 'OK', 
    message: 'Server is running and protected!',
    timestamp: new Date().toISOString(),
    port: port,
    authenticated: true,
    hasOpenAI: !!process.env.OPENAI_API_KEY,
    model: modelName
  });
});

// Health check Ù„Ù„Ù€ Railway (Ø¨Ø¯ÙˆÙ† Ø­Ù…Ø§ÙŠØ©)
app.get('/health', (req, res) => {
  res.status(200).json({ status: 'healthy' });
});

// Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª
async function extractText(filePath, mimetype) {
  console.log(`ğŸ“„ Extracting text from: ${mimetype}`);
  
  if (mimetype === 'application/pdf') {
    const buffer = fs.readFileSync(filePath);
    const pdfData = await pdfParse(buffer);
    return pdfData.text;
  } else if (mimetype.startsWith('image/')) {
    const { data: { text } } = await Tesseract.recognize(filePath, 'ara+eng');
    return text;
  } else {
    throw new Error(`Unsupported file type: ${mimetype}`);
  }
}

// API endpoint Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
app.post('/api/analyze-invoice', upload.single('invoice'), async (req, res) => {
  if (!openai) {
    return res.status(500).json({ 
      success: false, 
      error: 'OpenAI API key not configured' 
    });
  }

  console.log('ğŸ”„ Starting invoice analysis...');
  
  try {
    if (!req.file) {
      return res.status(400).json({ 
        success: false, 
        error: 'No file uploaded' 
      });
    }

    const { path: filePath, mimetype, originalname } = req.file;
    console.log(`ğŸ“ File: ${originalname} - ${mimetype}`);

    let rawText;
    try {
      rawText = await extractText(filePath, mimetype);
    } catch (extractError) {
      console.error('âŒ Text extraction error:', extractError.message);
      return res.status(422).json({ 
        success: false, 
        error: `Failed to read file: ${extractError.message}` 
      });
    } finally {
      // Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¤Ù‚Øª
      try {
        if (fs.existsSync(filePath)) {
          fs.unlinkSync(filePath);
        }
      } catch (deleteError) {
        console.warn('âš ï¸ Failed to delete temp file');
      }
    }

    if (!rawText || rawText.trim().length < 10) {
      return res.status(422).json({ 
        success: false, 
        error: 'Could not extract sufficient text from invoice' 
      });
    }

    console.log(`ğŸ“ Text length: ${rawText.length} characters`);

    // ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
    const response = await openai.chat.completions.create({
      model: modelName,
      messages: [
        {
          role: 'system',
          content: `Extract invoice data and return as JSON with these fields: supplier, type, invoiceNumber, date (YYYY-MM-DD), amountBeforeTax, taxAmount, totalAmount`
        },
        { 
          role: 'user', 
          content: `Analyze this invoice:\n\n${rawText}` 
        }
      ],
      temperature: 0.1
    });

    const content = response.choices[0].message.content;
    let data;
    
    try {
      // Ø§Ø³ØªØ®Ø±Ø§Ø¬ JSON Ù…Ù† Ø§Ù„Ø±Ø¯
      const jsonMatch = content.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        data = JSON.parse(jsonMatch[0]);
      } else {
        throw new Error('No JSON found in response');
      }
    } catch (parseError) {
      console.error('âŒ JSON parsing error:', parseError.message);
      return res.status(500).json({ 
        success: false, 
        error: 'Error processing data' 
      });
    }

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const cleanData = {
      supplier: data.supplier || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
      type: data.type || 'ÙØ§ØªÙˆØ±Ø© Ø¹Ø§Ù…Ø©',
      invoiceNumber: data.invoiceNumber || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
      date: data.date || new Date().toISOString().split('T')[0],
      amountBeforeTax: parseFloat(data.amountBeforeTax) || 0,
      taxAmount: parseFloat(data.taxAmount) || 0,
      totalAmount: parseFloat(data.totalAmount) || 0
    };

    console.log('âœ… Invoice analyzed successfully');
    res.json({ success: true, data: cleanData });

  } catch (error) {
    console.error('âŒ Invoice analysis error:', error.message);
    
    // Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
    if (req.file && req.file.path && fs.existsSync(req.file.path)) {
      try {
        fs.unlinkSync(req.file.path);
      } catch (deleteError) {
        console.warn('âš ï¸ Failed to delete file after error');
      }
    }

    res.status(500).json({ 
      success: false, 
      error: 'Unexpected error occurred'
    });
  }
});

// Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
app.use((error, req, res, next) => {
  console.error('Unhandled error:', error);
  res.status(500).json({
    success: false,
    error: error.message || 'Server error'
  });
});

// Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ uploads
if (!fs.existsSync('uploads')) {
  fs.mkdirSync('uploads');
  console.log('ğŸ“ Created uploads directory');
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…
app.listen(port, '0.0.0.0', () => {
  console.log(`âœ… Server running on port ${port}`);
  console.log(`ğŸ” Protected with authentication`);
  console.log(`ğŸ‘¤ Username: ${AUTH_USERNAME}`);
  console.log(`ğŸ—ï¸ Password: ${AUTH_PASSWORD}`);
});

// Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø®Ø§Ø¯Ù… Ø¨Ø£Ù…Ø§Ù†
process.on('SIGTERM', () => {
  console.log('ğŸ”„ SIGTERM received, shutting down gracefully');
  process.exit(0);
});

process.on('SIGINT', () => {
  console.log('ğŸ”„ SIGINT received, shutting down gracefully');
  process.exit(0);
});